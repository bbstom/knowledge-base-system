# ğŸ”§ ä¿®å¤æ¨èç ç´¢å¼•é”™è¯¯

## ğŸ› é”™è¯¯ä¿¡æ¯

```
E11000 duplicate key error collection: userdata.users 
index: referral_code_1 dup key: { referral_code: null }
```

## ğŸ“‹ é—®é¢˜åŸå› 

æ•°æ®åº“ä¸­ `referralCode` å­—æ®µæœ‰å”¯ä¸€ç´¢å¼•ï¼Œä½†ä¸æ˜¯ç¨€ç–ç´¢å¼•ï¼Œå¯¼è‡´ï¼š
- å¤šä¸ªç”¨æˆ·çš„ `referralCode` ä¸º `null`
- å”¯ä¸€ç´¢å¼•ä¸å…è®¸å¤šä¸ª `null` å€¼
- åˆ›å»ºæ–°ç”¨æˆ·æ—¶æŠ¥é”™

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ³•1ï¼šè¿è¡Œä¿®å¤è„šæœ¬ï¼ˆæ¨èï¼‰

**æ­¥éª¤ï¼š**

1. **è¿›å…¥serverç›®å½•**
   ```bash
   cd server
   ```

2. **è¿è¡Œä¿®å¤è„šæœ¬**
   ```bash
   node scripts/fixReferralCodeIndex.js
   ```

3. **æŸ¥çœ‹è¾“å‡º**
   ```
   âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ
   
   ğŸ“ å‘ç° X ä¸ªç”¨æˆ·æ²¡æœ‰æ¨èç 
   æ­£åœ¨ä¸ºè¿™äº›ç”¨æˆ·ç”Ÿæˆæ¨èç ...
   
   âœ… ç”¨æˆ· user1 (user1@example.com) - æ¨èç : ABC12345
   âœ… ç”¨æˆ· user2 (user2@example.com) - æ¨èç : XYZ67890
   
   âœ… å·²ä¸º X ä¸ªç”¨æˆ·ç”Ÿæˆæ¨èç 
   
   ğŸ“ æ£€æŸ¥å¹¶æ›´æ–°ç´¢å¼•...
   âœ… å·²åˆ é™¤æ—§çš„ referralCode ç´¢å¼•
   âœ… å·²åˆ›å»ºæ–°çš„ç¨€ç–ç´¢å¼•ï¼ˆå…è®¸å¤šä¸ªnullå€¼ï¼‰
   
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   âœ… ä¿®å¤å®Œæˆï¼
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   ```

4. **é‡æ–°åˆ›å»ºç®¡ç†å‘˜**
   ```bash
   node scripts/createAdmin.js
   ```

---

### æ–¹æ³•2ï¼šæ‰‹åŠ¨ä¿®å¤ï¼ˆé«˜çº§ï¼‰

#### ä½¿ç”¨MongoDB Shell

1. **è¿æ¥æ•°æ®åº“**
   ```bash
   mongosh "mongodb://chroot:Ubuntu123!@172.16.254.15:27017/userdata?authSource=admin"
   ```

2. **ä¸ºæ‰€æœ‰ç”¨æˆ·ç”Ÿæˆæ¨èç **
   ```javascript
   // ç”Ÿæˆæ¨èç å‡½æ•°
   function generateCode() {
     const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
     let code = '';
     for (let i = 0; i < 8; i++) {
       code += chars.charAt(Math.floor(Math.random() * chars.length));
     }
     return code;
   }
   
   // æ›´æ–°æ‰€æœ‰æ²¡æœ‰æ¨èç çš„ç”¨æˆ·
   db.users.find({ referralCode: null }).forEach(function(user) {
     db.users.updateOne(
       { _id: user._id },
       { $set: { referralCode: generateCode() } }
     );
   });
   ```

3. **åˆ é™¤æ—§ç´¢å¼•**
   ```javascript
   db.users.dropIndex('referralCode_1');
   ```

4. **åˆ›å»ºæ–°çš„ç¨€ç–ç´¢å¼•**
   ```javascript
   db.users.createIndex(
     { referralCode: 1 }, 
     { unique: true, sparse: true }
   );
   ```

---

## ğŸ” éªŒè¯ä¿®å¤

### 1. æ£€æŸ¥æ‰€æœ‰ç”¨æˆ·éƒ½æœ‰æ¨èç 
```javascript
// MongoDB Shell
db.users.count({ referralCode: null })
// åº”è¯¥è¿”å› 0
```

### 2. æ£€æŸ¥ç´¢å¼•
```javascript
db.users.getIndexes()
// åº”è¯¥çœ‹åˆ° referralCode ç´¢å¼•æœ‰ sparse: true
```

### 3. æµ‹è¯•åˆ›å»ºç®¡ç†å‘˜
```bash
node scripts/createAdmin.js
```

---

## ğŸ“ å·²ä¿®å¤çš„å†…å®¹

### 1. Useræ¨¡å‹æ›´æ–° âœ…
**æ–‡ä»¶ï¼š** `server/models/User.js`

**ä¿®æ”¹å‰ï¼š**
```javascript
referralCode: {
  type: String,
  unique: true
}
```

**ä¿®æ”¹åï¼š**
```javascript
referralCode: {
  type: String,
  unique: true,
  sparse: true  // å…è®¸å¤šä¸ªnullå€¼
}
```

### 2. åˆ›å»ºç®¡ç†å‘˜è„šæœ¬å¢å¼º âœ…
**æ–‡ä»¶ï¼š** `server/scripts/createAdmin.js`

**æ–°å¢åŠŸèƒ½ï¼š**
- è‡ªåŠ¨æ£€æŸ¥å¹¶ä¿®å¤æ²¡æœ‰æ¨èç çš„ç”¨æˆ·
- ä¸ºç®¡ç†å‘˜ç”Ÿæˆæ¨èç 
- æ›´å¥½çš„é”™è¯¯æç¤º

### 3. ä¿®å¤è„šæœ¬ âœ…
**æ–‡ä»¶ï¼š** `server/scripts/fixReferralCodeIndex.js`

**åŠŸèƒ½ï¼š**
- ä¸ºæ‰€æœ‰ç”¨æˆ·ç”Ÿæˆæ¨èç 
- åˆ é™¤æ—§ç´¢å¼•
- åˆ›å»ºæ–°çš„ç¨€ç–ç´¢å¼•

---

## ğŸ¯ å®Œæ•´æµç¨‹

### ä»å¤´å¼€å§‹ä¿®å¤å¹¶åˆ›å»ºç®¡ç†å‘˜

```bash
# 1. è¿›å…¥serverç›®å½•
cd server

# 2. ä¿®å¤æ¨èç ç´¢å¼•
node scripts/fixReferralCodeIndex.js

# 3. åˆ›å»ºç®¡ç†å‘˜
node scripts/createAdmin.js

# 4. ç™»å½•æµ‹è¯•
# è®¿é—®: http://localhost:5173/login
# é‚®ç®±: admin@example.com
# å¯†ç : admin123456
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å¤‡ä»½æ•°æ®ï¼ˆå¯é€‰ä½†æ¨èï¼‰
```bash
mongodump --uri="mongodb://chroot:Ubuntu123!@172.16.254.15:27017/userdata?authSource=admin" --out=backup
```

### 2. ç¡®ä¿åœ¨æ­£ç¡®çš„ç›®å½•
```bash
# å¿…é¡»åœ¨ server ç›®å½•ä¸‹è¿è¡Œ
pwd
# åº”è¯¥æ˜¾ç¤º: .../knowbase2/server
```

### 3. æ£€æŸ¥æ•°æ®åº“è¿æ¥
```bash
# ç¡®ä¿ .env æ–‡ä»¶å­˜åœ¨ä¸”é…ç½®æ­£ç¡®
cat .env | grep USER_MONGO_URI
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: ä¿®å¤è„šæœ¬è¿è¡Œå¤±è´¥
**é”™è¯¯ï¼š** æ•°æ®åº“è¿æ¥å¤±è´¥

**è§£å†³ï¼š**
1. æ£€æŸ¥MongoDBæœåŠ¡æ˜¯å¦è¿è¡Œ
2. æ£€æŸ¥ `.env` é…ç½®
3. ç¡®è®¤ç½‘ç»œè¿æ¥

### Q2: ä»ç„¶æŠ¥é‡å¤é”®é”™è¯¯
**åŸå› ï¼š** ç´¢å¼•æ²¡æœ‰æ­£ç¡®æ›´æ–°

**è§£å†³ï¼š**
```bash
# é‡æ–°è¿è¡Œä¿®å¤è„šæœ¬
node scripts/fixReferralCodeIndex.js
```

### Q3: ç”¨æˆ·æ¨èç å†²çª
**åŸå› ï¼š** ç”Ÿæˆçš„æ¨èç é‡å¤

**è§£å†³ï¼š**
è„šæœ¬ä¼šè‡ªåŠ¨é‡è¯•ç”Ÿæˆæ–°çš„æ¨èç 

---

## âœ… éªŒè¯æ¸…å•

ä¿®å¤å®Œæˆåï¼ŒéªŒè¯ä»¥ä¸‹å†…å®¹ï¼š

- [ ] æ‰€æœ‰ç”¨æˆ·éƒ½æœ‰æ¨èç 
- [ ] æ¨èç ç´¢å¼•æ˜¯ç¨€ç–ç´¢å¼•
- [ ] å¯ä»¥æˆåŠŸåˆ›å»ºç®¡ç†å‘˜
- [ ] ç®¡ç†å‘˜æœ‰æ¨èç 
- [ ] å¯ä»¥ç™»å½•ç®¡ç†åå°

---

## ğŸ“Š æŠ€æœ¯è¯´æ˜

### ä»€ä¹ˆæ˜¯ç¨€ç–ç´¢å¼•ï¼Ÿ

**æ™®é€šå”¯ä¸€ç´¢å¼•ï¼š**
- ä¸å…è®¸å¤šä¸ª `null` å€¼
- æ‰€æœ‰æ–‡æ¡£éƒ½å¿…é¡»æœ‰è¯¥å­—æ®µ

**ç¨€ç–å”¯ä¸€ç´¢å¼•ï¼š**
- å…è®¸å¤šä¸ª `null` å€¼
- åªå¯¹é `null` å€¼å¼ºåˆ¶å”¯ä¸€
- æ›´é€‚åˆå¯é€‰å­—æ®µ

### ä¸ºä»€ä¹ˆéœ€è¦æ¨èç ï¼Ÿ

æ¨èç ç”¨äºï¼š
- ç”¨æˆ·æ¨èç³»ç»Ÿ
- è¿½è¸ªæ¨èå…³ç³»
- è®¡ç®—æ¨èå¥–åŠ±

---

**åˆ›å»ºæ—¶é—´ï¼š** 2024-10-19  
**çŠ¶æ€ï¼š** âœ… å¯ç”¨  
**ä¼˜å…ˆçº§ï¼š** ğŸ”´ é«˜ï¼ˆå¿…é¡»å…ˆä¿®å¤æ‰èƒ½åˆ›å»ºç®¡ç†å‘˜ï¼‰
