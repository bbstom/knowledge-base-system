# 余额和积分系统修复完成

## ✅ 已完成的修复

### 1. 充值功能修复
**文件**: `server/services/rechargeService.js`

**修改前**：充值直接增加积分
```javascript
user.points += order.points; // ❌ 错误
```

**修改后**：充值增加余额
```javascript
user.balance += order.amount; // ✅ 正确
```

### 2. 搜索功能修复
**文件**: `server/routes/search.js`

**修改前**：搜索扣除余额
```javascript
user.balance -= searchCost; // ❌ 错误
```

**修改后**：搜索扣除积分
```javascript
user.points -= searchCost; // ✅ 正确
```

### 3. 新增购买积分功能
**文件**: `server/routes/user.js`

**新增API**: `POST /api/user/buy-points`

**功能**：
- 用户使用余额购买积分
- 兑换比例：1元 = 10积分（可配置）
- 扣除余额，增加积分
- 记录两条日志：余额消费 + 积分购买

**请求**：
```json
{
  "amount": 100  // 购买100积分
}
```

**响应**：
```json
{
  "success": true,
  "message": "成功购买100积分",
  "data": {
    "pointsAdded": 100,
    "costBalance": 10,
    "newBalance": 90,
    "newPoints": 100
  }
}
```

### 4. 更新BalanceLog模型
**文件**: `server/models/BalanceLog.js`

**新增类型**：
- `points_purchase` - 购买积分
- `withdraw` - 提现

**完整类型列表**：
```javascript
enum: [
  'recharge',         // 充值（增加余额）
  'consume',          // 消费（减少余额）
  'refund',           // 退款（增加余额）
  'commission',       // 推荐奖励（增加余额）
  'vip',             // VIP充值（减少余额）
  'search',          // 搜索消费（减少积分）
  'points_purchase', // 购买积分（增加积分）
  'withdraw'         // 提现（减少余额）
]
```

### 5. 更新前端显示
**文件**: `src/pages/Dashboard/BalanceLogs.tsx`

**更新类型标签**：
- 充值余额（绿色）
- 消费余额（红色）
- 购买积分（蓝色）
- 搜索消费（红色）
- 提现（橙色）

## 📊 完整的资金流程

### 流程图
```
充值 → 余额增加
  ↓
购买积分 → 余额减少 + 积分增加
  ↓
搜索 → 积分减少
  ↓
提现 ← 余额减少
```

### 详细说明

#### 1. 充值流程
```
用户支付 ¥100
  ↓
余额 +¥100
  ↓
记录：充值余额 +¥100
```

#### 2. 购买积分流程
```
用户购买 1000积分
  ↓
计算成本：1000 ÷ 10 = ¥100
  ↓
余额 -¥100
积分 +1000
  ↓
记录1：消费余额 -¥100（购买1000积分）
记录2：购买积分 +1000（花费¥100）
```

#### 3. 搜索流程
```
用户搜索（成本10积分）
  ↓
积分 -10
  ↓
记录：搜索消费 -10积分
```

#### 4. 提现流程
```
用户提现 ¥50
  ↓
余额 -¥50
  ↓
转账到USDT钱包
  ↓
记录：提现 -¥50
```

## 🎯 核心概念

### 余额（Balance）
- **定义**：可以提现的真实货币
- **来源**：充值、推荐奖励、退款
- **用途**：购买积分、购买VIP、提现
- **单位**：元（¥）

### 积分（Points）
- **定义**：用于查询消费的虚拟货币
- **来源**：购买（用余额兑换）
- **用途**：搜索查询
- **单位**：积分
- **特点**：不能提现，只能消费

## 📱 用户界面

### Dashboard概览
```
┌─────────────────────────────────┐
│ 余额: ¥100.00  （可提现）       │
│ 积分: 1000     （用于搜索）     │
└─────────────────────────────────┘
```

### 充值中心
```
选择充值金额 → 支付 → 余额增加
```

### 购买积分（需要新建页面）
```
输入积分数量 → 计算成本 → 确认购买
兑换比例：1元 = 10积分
```

### 搜索页面
```
当前积分: 1000
本次搜索消耗: 10积分
积分不足？ → 去购买积分
```

## 🔧 修改的文件

1. ✅ `server/services/rechargeService.js` - 充值增加余额
2. ✅ `server/routes/search.js` - 搜索扣除积分
3. ✅ `server/routes/user.js` - 新增购买积分API
4. ✅ `server/models/BalanceLog.js` - 新增类型
5. ✅ `src/pages/Dashboard/BalanceLogs.tsx` - 更新类型显示

## 📝 待完成的工作

### 前端页面
- [ ] 创建购买积分页面 `src/pages/Dashboard/BuyPoints.tsx`
- [ ] 在Dashboard添加"购买积分"按钮
- [ ] 在搜索页面添加"积分不足"提示和购买链接
- [ ] 更新充值页面说明（充值是增加余额）

### API方法
- [ ] 在 `src/utils/api.ts` 添加 `buyPoints` 方法
```typescript
export const userApi = {
  // ... 其他方法
  
  async buyPoints(amount: number) {
    return apiRequest('/api/user/buy-points', {
      method: 'POST',
      body: JSON.stringify({ amount })
    });
  }
};
```

### 路由配置
- [ ] 在 `src/App.tsx` 添加购买积分路由
```typescript
<Route path="/dashboard/buy-points" element={<BuyPoints />} />
```

### 系统配置
- [ ] 在SystemConfig中添加积分兑换比例配置
- [ ] 在管理后台添加积分价格设置

## 🧪 测试步骤

### 1. 测试充值
1. 进入充值中心
2. 选择充值金额（如¥100）
3. 完成支付
4. 检查余额是否增加¥100
5. 检查积分是否**没有**变化

### 2. 测试购买积分
1. 确保有足够余额
2. 进入购买积分页面
3. 输入积分数量（如1000）
4. 确认购买
5. 检查余额减少¥100
6. 检查积分增加1000

### 3. 测试搜索
1. 确保有足够积分
2. 进行一次搜索
3. 检查积分减少
4. 检查余额**没有**变化

### 4. 测试积分不足
1. 将积分消耗到不足
2. 尝试搜索
3. 应该提示"积分不足"
4. 引导用户购买积分

## ✨ 总结

现在系统已经正确区分了余额和积分：

- ✅ **充值** → 增加余额（可提现）
- ✅ **购买积分** → 余额换积分（新功能）
- ✅ **搜索** → 消耗积分
- ✅ **提现** → 减少余额

用户流程更加清晰：
1. 充值获得余额
2. 用余额购买积分
3. 用积分进行搜索
4. 剩余余额可以提现

这样就完全符合你的需求了！🎉
