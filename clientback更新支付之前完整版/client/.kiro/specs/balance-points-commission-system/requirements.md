# 余额、积分、佣金系统需求文档

## 简介

本文档定义了系统中三种货币的完整逻辑：积分（Points）、余额（Balance）、佣金（Commission）。

## 术语表

- **积分（Points）**: 用于搜索查询的虚拟货币，可通过充值或余额兑换获得
- **余额（Balance）**: 中间货币，可通过佣金转入或充值获得，只能兑换成积分，不能提现
- **佣金（Commission）**: 推荐奖励，可提现到USDT钱包或转入余额
- **充值（Recharge）**: 用户支付真实货币购买积分或VIP
- **兑换（Exchange）**: 余额转换为积分
- **提现（Withdraw）**: 佣金转出到USDT钱包

## 需求

### 需求1：充值系统

**用户故事**: 作为用户，我想要充值，以便获得积分或VIP会员资格

#### 验收标准

1. WHEN 用户选择积分充值套餐并完成支付，THE 系统 SHALL 增加用户的积分数量
2. WHEN 用户选择VIP充值套餐并完成支付，THE 系统 SHALL 延长用户的VIP有效期
3. THE 系统 SHALL 记录充值日志，包含充值类型、金额、获得的积分或VIP天数
4. THE 系统 SHALL 在充值成功后通知用户

### 需求2：搜索消费系统

**用户故事**: 作为用户，我想要使用积分进行搜索，以便查询信息

#### 验收标准

1. WHEN 用户发起搜索请求，THE 系统 SHALL 检查用户积分是否足够
2. IF 用户积分不足，THEN THE 系统 SHALL 返回错误提示"积分不足"
3. WHEN 搜索成功且找到结果，THE 系统 SHALL 扣除相应的积分
4. WHEN 搜索为重复搜索或无结果，THE 系统 SHALL 不扣除积分
5. THE 系统 SHALL 记录搜索日志，包含搜索类型、查询内容、结果数量、消耗积分

### 需求3：推荐佣金系统

**用户故事**: 作为推荐人，我想要获得推荐佣金，以便从被推荐人的消费中获利

#### 验收标准

1. WHEN 被推荐用户充值积分，THE 系统 SHALL 计算推荐佣金并增加推荐人的佣金余额
2. WHEN 被推荐用户购买VIP，THE 系统 SHALL 计算推荐佣金并增加推荐人的佣金余额
3. THE 系统 SHALL 根据配置的佣金比例计算佣金金额
4. THE 系统 SHALL 记录佣金日志，包含来源用户、佣金金额、佣金类型
5. THE 系统 SHALL 支持多级佣金（一级、二级、三级）

### 需求4：佣金提现系统

**用户故事**: 作为用户，我想要提现佣金，以便将收益转换为真实货币或余额

#### 验收标准

1. WHEN 用户选择提现到USDT钱包，THE 系统 SHALL 扣除佣金并创建提现订单
2. WHEN 用户选择提现到余额，THE 系统 SHALL 扣除佣金并增加余额
3. THE 系统 SHALL 检查提现金额是否达到最低提现额度
4. THE 系统 SHALL 根据配置收取提现手续费
5. THE 系统 SHALL 记录提现日志，包含提现类型、金额、手续费、目标地址

### 需求5：余额兑换积分系统

**用户故事**: 作为用户，我想要用余额兑换积分，以便继续使用搜索功能

#### 验收标准

1. WHEN 用户输入兑换积分数量，THE 系统 SHALL 根据兑换汇率计算所需余额
2. THE 系统 SHALL 检查用户余额是否足够
3. IF 余额不足，THEN THE 系统 SHALL 返回错误提示"余额不足"
4. WHEN 兑换成功，THE 系统 SHALL 扣除余额并增加积分
5. THE 系统 SHALL 记录兑换日志，包含兑换数量、消耗余额、兑换汇率
6. THE 系统 SHALL 从配置中读取兑换汇率（默认1元=10积分）

### 需求6：商城页面

**用户故事**: 作为用户，我想要访问商城页面，以便兑换积分和查看其他商品

#### 验收标准

1. THE 系统 SHALL 在导航栏显示"商城"菜单项
2. WHEN 用户点击商城菜单，THE 系统 SHALL 显示商城页面
3. THE 商城页面 SHALL 显示余额兑换积分功能
4. THE 商城页面 SHALL 显示当前余额和积分
5. THE 商城页面 SHALL 显示兑换汇率
6. THE 商城页面 SHALL 提供兑换表单，包含输入框和确认按钮

### 需求7：管理员配置

**用户故事**: 作为管理员，我想要配置系统参数，以便灵活调整业务规则

#### 验收标准

1. THE 系统 SHALL 允许管理员配置余额兑换积分汇率
2. THE 系统 SHALL 允许管理员配置搜索消耗积分数量
3. THE 系统 SHALL 允许管理员配置佣金比例（一级、二级、三级）
4. THE 系统 SHALL 允许管理员配置提现最低金额
5. THE 系统 SHALL 允许管理员配置提现手续费比例
6. THE 系统 SHALL 允许管理员配置USDT兑换汇率

## 数据模型

### User模型扩展
```javascript
{
  points: Number,        // 积分
  balance: Number,       // 余额（不可提现）
  commission: Number,    // 佣金（可提现）
  // ... 其他字段
}
```

### BalanceLog类型
```javascript
enum: [
  'recharge',      // 充值积分
  'search',        // 搜索消费
  'commission',    // 获得佣金
  'exchange',      // 余额兑换积分
  'withdraw',      // 佣金提现
  'commission_to_balance', // 佣金转余额
  // ... 其他类型
]
```

## 资金流程图

```
充值 → 积分 → 搜索消费

推荐佣金 → 佣金账户 → 提现到USDT
                    ↓
                 转入余额 → 兑换积分 → 搜索消费
```

## 约束条件

1. 积分只能通过充值或余额兑换获得
2. 积分只能用于搜索，不能提现或转账
3. 余额只能通过佣金转入获得
4. 余额只能兑换成积分，不能提现
5. 佣金只能通过推荐获得
6. 佣金可以提现到USDT或转入余额
7. 所有货币变动必须记录日志

## 非功能需求

1. 所有金额计算必须精确到小数点后2位
2. 所有货币操作必须是原子性的（事务）
3. 系统必须防止负数余额/积分/佣金
4. 提现操作必须有审核机制
5. 所有配置必须可以热更新（无需重启）
