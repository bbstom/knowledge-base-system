# ðŸš¨ æ•°æ®åº“è¿žæŽ¥é—®é¢˜ - ä»£ç ä¿®å¤æ–¹æ¡ˆ

## é—®é¢˜
é‡å¯PM2åŽç™»å½•ä»ç„¶å¤±è´¥ï¼š
```
MongoNotConnectedError: Client must be connected before running operations
```

## æ ¹æœ¬åŽŸå› 
æ•°æ®åº“åœ¨å¯åŠ¨åŽè¢«é‡æ–°è¿žæŽ¥ï¼Œä½†Mongooseæ¨¡åž‹ä»ç„¶ä½¿ç”¨æ—§è¿žæŽ¥ã€‚è¿™æ˜¯ `DATABASE_CONNECTION_DISCONNECT_FIX.md` ä¸­è®°å½•çš„å·²çŸ¥é—®é¢˜ã€‚

---

## âœ… ä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼ˆç«‹å³å¯ç”¨ï¼‰

### æ–¹æ³•1ï¼šç¦ç”¨æ•°æ®åº“é…ç½®é‡æ–°è¿žæŽ¥

åœ¨ç”Ÿäº§æœåŠ¡å™¨ä¸Šï¼Œæš‚æ—¶ç¦ç”¨æ•°æ®åº“é…ç½®åŠŸèƒ½ï¼š

```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd /var/www/html/knowledge-base-system/client

# 2. å¤‡ä»½å½“å‰é…ç½®
cp server/index.js server/index.js.backup

# 3. ç¼–è¾‘server/index.js
# æ‰¾åˆ°å¹¶æ³¨é‡ŠæŽ‰æ•°æ®åº“é…ç½®åˆå§‹åŒ–çš„ä»£ç 
```

### æ–¹æ³•2ï¼šæ¸…ç©ºæ•°æ®åº“é…ç½®ï¼ˆæŽ¨èï¼‰

```bash
# åœ¨ç”Ÿäº§æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
cd /var/www/html/knowledge-base-system/client

# åˆ›å»ºæ¸…ç©ºè„šæœ¬
cat > clear-db-config.js << 'EOF'
require('dotenv').config({ path: require('path').join(__dirname, 'server', '.env') });
const mongoose = require('mongoose');

async function clearConfig() {
  try {
    const uri = process.env.USER_MONGO_URI;
    await mongoose.connect(uri);
    
    const SystemConfig = mongoose.model('SystemConfig', new mongoose.Schema({}, { strict: false }));
    
    // åˆ é™¤æ•°æ®åº“é…ç½®
    await SystemConfig.deleteMany({ key: { $in: ['userDatabase', 'queryDatabases'] } });
    
    console.log('âœ… æ•°æ®åº“é…ç½®å·²æ¸…ç©º');
    process.exit(0);
  } catch (error) {
    console.error('âŒ æ¸…ç©ºå¤±è´¥:', error.message);
    process.exit(1);
  }
}

clearConfig();
EOF

# æ‰§è¡Œæ¸…ç©º
node clear-db-config.js

# é‡å¯PM2
pm2 restart base2

# æŸ¥çœ‹æ—¥å¿—
pm2 logs base2 --lines 50
```

---

## ðŸ” éªŒè¯ä¿®å¤

### 1. æŸ¥çœ‹æ—¥å¿—

```bash
pm2 logs base2 --lines 50
```

åº”è¯¥**ä¸å†çœ‹åˆ°**ï¼š
```
ðŸ“ å‘çŽ°æ•°æ®åº“é…ç½®ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°è¿žæŽ¥...
ðŸ”„ ä½¿ç”¨é…ç½®çš„ç”¨æˆ·æ•°æ®åº“é‡æ–°è¿žæŽ¥...
```

### 2. æµ‹è¯•ç™»å½•

åœ¨å‰ç«¯é¡µé¢å°è¯•ç™»å½•ï¼Œåº”è¯¥å¯ä»¥æ­£å¸¸ç™»å½•ã€‚

---

## ðŸ“‹ ä¸ºä»€ä¹ˆè¿™æ ·èƒ½è§£å†³

### é—®é¢˜æµç¨‹

1. æœåŠ¡å™¨å¯åŠ¨ï¼Œä½¿ç”¨.envä¸­çš„é…ç½®è¿žæŽ¥æ•°æ®åº“ âœ…
2. å‘çŽ°SystemConfigä¸­æœ‰æ•°æ®åº“é…ç½®
3. å…³é—­å½“å‰è¿žæŽ¥ï¼Œä½¿ç”¨SystemConfigä¸­çš„é…ç½®é‡æ–°è¿žæŽ¥
4. **é—®é¢˜ï¼š** Mongooseæ¨¡åž‹è¿˜åœ¨ä½¿ç”¨æ—§è¿žæŽ¥ âŒ
5. ç™»å½•æ—¶æŸ¥è¯¢ç”¨æˆ·ï¼Œä½¿ç”¨æ—§è¿žæŽ¥ â†’ å¤±è´¥

### è§£å†³æ–¹æ¡ˆ

æ¸…ç©ºSystemConfigä¸­çš„æ•°æ®åº“é…ç½®åŽï¼š
1. æœåŠ¡å™¨å¯åŠ¨ï¼Œä½¿ç”¨.envä¸­çš„é…ç½®è¿žæŽ¥æ•°æ®åº“ âœ…
2. æ²¡æœ‰å‘çŽ°SystemConfigä¸­çš„é…ç½®
3. **ä¸ä¼šé‡æ–°è¿žæŽ¥** âœ…
4. Mongooseæ¨¡åž‹ä½¿ç”¨æ­£ç¡®çš„è¿žæŽ¥ âœ…
5. ç™»å½•æˆåŠŸ âœ…

---

## ðŸŽ¯ å®Œæ•´æ‰§è¡Œæ­¥éª¤

```bash
# 1. SSHç™»å½•åˆ°ç”Ÿäº§æœåŠ¡å™¨
ssh root@your-server

# 2. è¿›å…¥é¡¹ç›®ç›®å½•
cd /var/www/html/knowledge-base-system/client

# 3. åˆ›å»ºæ¸…ç©ºè„šæœ¬
cat > clear-db-config.js << 'EOF'
require('dotenv').config({ path: require('path').join(__dirname, 'server', '.env') });
const mongoose = require('mongoose');

async function clearConfig() {
  try {
    const uri = process.env.USER_MONGO_URI;
    console.log('è¿žæŽ¥æ•°æ®åº“...');
    await mongoose.connect(uri);
    
    const SystemConfig = mongoose.model('SystemConfig', new mongoose.Schema({}, { strict: false }));
    
    console.log('åˆ é™¤æ•°æ®åº“é…ç½®...');
    const result = await SystemConfig.deleteMany({ 
      key: { $in: ['userDatabase', 'queryDatabases'] } 
    });
    
    console.log(`âœ… å·²åˆ é™¤ ${result.deletedCount} æ¡é…ç½®`);
    await mongoose.disconnect();
    process.exit(0);
  } catch (error) {
    console.error('âŒ å¤±è´¥:', error.message);
    process.exit(1);
  }
}

clearConfig();
EOF

# 4. æ‰§è¡Œæ¸…ç©º
node clear-db-config.js

# 5. åˆ é™¤è„šæœ¬
rm clear-db-config.js

# 6. é‡å¯PM2
pm2 restart base2

# 7. ç­‰å¾…5ç§’
sleep 5

# 8. æŸ¥çœ‹æ—¥å¿—
pm2 logs base2 --lines 50

# 9. æµ‹è¯•ç™»å½•
echo "çŽ°åœ¨å¯ä»¥åœ¨å‰ç«¯æµ‹è¯•ç™»å½•äº†"
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### æ¸…ç©ºé…ç½®çš„å½±å“

æ¸…ç©ºSystemConfigä¸­çš„æ•°æ®åº“é…ç½®åŽï¼š
- âœ… ç™»å½•åŠŸèƒ½æ¢å¤æ­£å¸¸
- âœ… æ‰€æœ‰åŠŸèƒ½æ­£å¸¸ä½¿ç”¨
- âš ï¸ ç®¡ç†åŽå°çš„"æ•°æ®åº“é…ç½®"åŠŸèƒ½å°†æ˜¾ç¤ºç©ºé…ç½®
- âš ï¸ å¦‚æžœéœ€è¦ä½¿ç”¨å¤šæ•°æ®åº“åŠŸèƒ½ï¼Œéœ€è¦é‡æ–°é…ç½®

### å¦‚æžœä¸æƒ³æ¸…ç©ºé…ç½®

å‚è€ƒ `DATABASE_CONNECTION_DISCONNECT_FIX.md` ä¸­çš„ä»£ç ä¿®å¤æ–¹æ¡ˆï¼Œéœ€è¦ä¿®æ”¹æ•°æ®åº“åˆå§‹åŒ–é€»è¾‘ã€‚

---

## ðŸ“ž ç›¸å…³æ–‡æ¡£

- **DATABASE_CONNECTION_DISCONNECT_FIX.md** - è¯¦ç»†çš„ä»£ç ä¿®å¤æ–¹æ¡ˆ
- **DATABASE_CONNECTION_TIMING_FIX.md** - è¿žæŽ¥æ—¶åºé—®é¢˜
- **PRODUCTION_LOGIN_FINAL_FIX.md** - ç™»å½•é—®é¢˜ä¿®å¤

---

**çŠ¶æ€ï¼š** ðŸš¨ éœ€è¦ä»£ç ä¿®å¤  
**ä¼˜å…ˆçº§ï¼š** æœ€é«˜  
**é¢„è®¡æ—¶é—´ï¼š** 5åˆ†é’Ÿ  
**æ—¥æœŸï¼š** 2024-11-09

**ç«‹å³æ‰§è¡Œï¼š** è¿è¡Œä¸Šé¢çš„å®Œæ•´æ‰§è¡Œæ­¥éª¤
