# 📚 数据库配置指南

## ✅ 好消息

你的系统**已经支持在管理员后台配置数据库**，不需要修改 .env 文件！

## 🎯 两种配置方式

### 方式1: 管理员后台配置（推荐）✨

#### 优点
- ✅ 无需重启服务器
- ✅ 图形化界面，操作简单
- ✅ 密码自动加密存储
- ✅ 支持连接测试
- ✅ 实时状态监控
- ✅ 支持多个查询数据库

#### 使用步骤

1. **登录管理员后台**
   - 访问：`http://your-domain/admin`
   - 使用管理员账号登录

2. **进入数据库配置**
   - 点击左侧菜单：`系统设置`
   - 选择标签页：`数据库配置`

3. **配置用户数据库**
   ```
   名称: 用户数据库
   类型: MongoDB
   主机: 172.16.254.15
   端口: 27017
   用户名: chroot
   密码: Ubuntu123!
   数据库名: userdata
   认证数据库: admin
   ```

4. **配置查询数据库**（可选）
   - 点击"添加查询数据库"
   - 填写数据库信息
   - 可以添加多个查询数据库

5. **测试连接**
   - 点击"测试连接"按钮
   - 确认连接成功

6. **保存配置**
   - 点击"保存配置"按钮
   - 配置立即生效

### 方式2: .env 文件配置（传统方式）

#### 优点
- ✅ 适合初始部署
- ✅ 配置简单直接

#### 缺点
- ❌ 需要重启服务器
- ❌ 密码明文存储
- ❌ 需要服务器访问权限

#### 配置示例

编辑 `server/.env` 文件：

```env
# 用户数据库
USER_MONGO_URI=mongodb://chroot:Ubuntu123!@172.16.254.15:27017/userdata?authSource=admin

# 查询数据库
QUERY_MONGO_URI=mongodb://daroot:Ubuntu123!@172.16.254.77:27017/dabase?authSource=admin
```

重启服务器：
```bash
npm start
```

## 🔄 配置优先级

系统会按以下顺序使用配置：

1. **管理员后台配置**（优先）
   - 如果在后台配置了数据库，系统会使用这个配置
   - 配置存储在 SystemConfig 集合中
   - 密码使用 AES-256-CBC 加密

2. **.env 文件配置**（备用）
   - 如果后台没有配置，使用 .env 文件
   - 适合首次启动或开发环境

## 🎨 管理员后台界面功能

### 用户数据库配置
- 📝 基本信息：名称、类型、主机、端口
- 🔐 认证信息：用户名、密码（加密存储）
- 🗄️ 数据库名称和认证数据库
- ⚙️ 连接池大小和超时设置
- 🔌 启用/禁用开关

### 查询数据库管理
- ➕ 添加多个查询数据库
- ✏️ 编辑现有数据库配置
- 🗑️ 删除不需要的数据库
- 📊 查看连接状态

### 实用功能
- 🧪 **连接测试**：保存前测试连接是否正常
- 👁️ **密码显示/隐藏**：点击眼睛图标切换
- 📡 **实时状态**：显示当前连接状态
- 💾 **一键保存**：保存所有配置

## 🔒 安全特性

### 密码加密
- 使用 AES-256-CBC 加密算法
- 密码在数据库中加密存储
- 前端显示时自动遮盖（******）

### 权限控制
- 只有管理员可以访问配置页面
- API 需要管理员权限验证
- 密码字段特殊保护

## 🧪 测试配置

### 测试数据库连接
```bash
# 测试管理器功能
node server/scripts/testDatabaseManager.js

# 测试 API
node server/scripts/testDatabaseAPI.js

# 测试服务器启动
node server/scripts/testServerStartup.js
```

### 查看连接状态
访问健康检查端点：
```
GET http://localhost:3001/health
```

返回示例：
```json
{
  "status": "ok",
  "databases": {
    "user": {
      "connected": true,
      "name": "userdata",
      "host": "172.16.254.15"
    },
    "query": [
      {
        "id": "db1",
        "name": "查询数据库1",
        "connected": true
      }
    ]
  }
}
```

## 💡 最佳实践

### 推荐配置流程

1. **首次部署**
   - 使用 .env 文件配置基本连接
   - 启动服务器，创建管理员账号

2. **后续管理**
   - 登录管理员后台
   - 在界面中配置数据库
   - 测试连接后保存
   - 后续修改都在后台进行

3. **生产环境**
   - 使用后台配置（密码加密）
   - 定期备份 SystemConfig 集合
   - 监控连接状态

### 注意事项

⚠️ **配置修改后**
- 后台配置修改后立即生效
- 不需要重启服务器
- 建议先测试连接再保存

⚠️ **密码安全**
- 后台配置的密码会加密存储
- .env 文件中的密码是明文
- 生产环境建议使用后台配置

⚠️ **备份重要**
- 定期备份数据库配置
- 导出 SystemConfig 集合
- 保存 .env 文件副本

## 🎯 总结

| 特性 | 后台配置 | .env 配置 |
|------|---------|-----------|
| 操作难度 | ⭐ 简单 | ⭐⭐ 中等 |
| 安全性 | ⭐⭐⭐ 高 | ⭐⭐ 中 |
| 灵活性 | ⭐⭐⭐ 高 | ⭐ 低 |
| 需要重启 | ❌ 否 | ✅ 是 |
| 密码加密 | ✅ 是 | ❌ 否 |
| 多数据库 | ✅ 支持 | ⚠️ 有限 |
| 推荐使用 | ✅ 是 | ⚠️ 仅初始 |

**结论：推荐使用管理员后台配置数据库！** 🎉
