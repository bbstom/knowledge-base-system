# 管理后台菜单重构 - 实现任务

## 任务列表

- [x] 1. 准备工作和类型定义


  - 创建新的类型定义文件
  - 安装必要的依赖包
  - _需求: 需求1, 需求2_



- [ ] 1.1 创建类型定义
  - 在 `src/types/menu.ts` 中定义 `MenuItem`, `SubMenuItem`, `MenuState` 接口
  - 导出类型供其他组件使用


  - _需求: 需求1.1, 需求1.2_



- [ ] 1.2 安装依赖
  - 安装 `framer-motion` 用于动画效果
  - 更新 package.json
  - _需求: 需求2.5_



- [ ] 2. 创建子菜单组件
  - 实现 MenuItemWithSubmenu 和 SubmenuItem 组件
  - 添加展开/收起动画
  - _需求: 需求1, 需求2, 需求3_



- [ ] 2.1 实现 SubmenuItem 组件
  - 创建 `src/components/Admin/SubmenuItem.tsx`
  - 实现基本渲染逻辑（标题、描述、激活状态）
  - 添加样式（缩进、字体大小、颜色）
  - 添加 hover 和 active 状态样式

  - _需求: 需求3.1, 需求3.2, 需求3.3_

- [ ] 2.2 实现 MenuItemWithSubmenu 组件
  - 创建 `src/components/Admin/MenuItemWithSubmenu.tsx`
  - 实现父级菜单头部（图标、标题、箭头）


  - 实现展开/收起逻辑
  - 集成 framer-motion 动画
  - 添加 ARIA 属性支持
  - _需求: 需求1.1, 需求1.2, 需求2.1, 需求2.2, 需求7.4_



- [ ] 2.3 添加动画效果
  - 使用 framer-motion 的 AnimatePresence 和 motion.div
  - 配置展开/收起动画（高度和透明度）
  - 添加箭头旋转动画

  - 确保动画流畅（60fps）
  - _需求: 需求2.5_

- [ ] 3. 更新 AdminLayout 组件
  - 添加菜单状态管理
  - 更新菜单配置数据

  - 集成新的子菜单组件
  - _需求: 需求1, 需求5, 需求6_

- [ ] 3.1 添加状态管理
  - 在 AdminLayout 中添加 `expandedMenus` 状态

  - 实现 `toggleMenu` 函数
  - 实现 `isMenuExpanded` 辅助函数
  - _需求: 需求2.1_

- [x] 3.2 实现状态持久化

  - 添加 localStorage 读取逻辑（组件挂载时）
  - 添加 localStorage 保存逻辑（状态变化时）
  - 使用防抖优化保存频率
  - 添加错误处理（localStorage 不可用时）
  - _需求: 需求6.1, 需求6.2, 需求6.4_


- [ ] 3.3 实现路由自动展开
  - 创建 `findParentMenuByPath` 辅助函数
  - 在路由变化时自动展开对应的父级菜单
  - 确保刷新页面后状态正确

  - _需求: 需求5.3, 需求5.4_

- [ ] 3.4 更新菜单配置数据
  - 修改 `menuItems` 数组，将"系统设置"改为带子菜单的结构
  - 移除原有的"网站配置"和"充值配置"独立菜单项

  - 添加子菜单配置（网站配置、充值配置）
  - _需求: 需求1.3_



- [ ] 3.5 集成子菜单组件
  - 在菜单渲染逻辑中判断是否有子菜单
  - 有子菜单时渲染 MenuItemWithSubmenu
  - 无子菜单时渲染普通 MenuItem
  - 传递正确的 props（展开状态、切换函数等）
  - _需求: 需求1.1, 需求1.4_


- [ ] 4. 实现路由匹配逻辑
  - 创建辅助函数判断菜单激活状态
  - 支持父子菜单的激活状态
  - _需求: 需求1, 需求3, 需求5_


- [ ] 4.1 实现 isMenuActive 函数
  - 判断普通菜单项是否激活
  - 判断带子菜单的菜单项是否激活（任一子项激活则父级激活）
  - 支持 exact 匹配模式
  - _需求: 需求3.4, 需求5.1, 需求5.2_

- [ ] 4.2 实现 isSubmenuActive 函数
  - 判断子菜单项是否激活
  - 使用 `startsWith` 匹配路由
  - _需求: 需求1.5_

- [ ] 5. 移动端适配
  - 优化触摸交互
  - 调整点击行为
  - _需求: 需求4_

- [ ] 5.1 优化移动端交互
  - 父级菜单点击时展开/收起，不关闭侧边栏
  - 子菜单点击时导航并关闭侧边栏
  - 增加最小点击区域（44x44px）
  - 添加 `touch-action: manipulation`
  - _需求: 需求4.1, 需求4.2, 需求4.3_

- [ ] 5.2 测试移动端体验
  - 在不同尺寸的移动设备上测试
  - 验证动画流畅性
  - 验证触摸响应
  - _需求: 需求4.4_

- [ ] 6. 无障碍功能实现
  - 添加 ARIA 属性
  - 实现键盘导航
  - _需求: 需求7_

- [ ] 6.1 添加 ARIA 属性
  - 为父级菜单添加 `aria-expanded`
  - 为父级菜单添加 `aria-controls`
  - 为子菜单容器添加 `role="menu"`
  - 为子菜单项添加 `role="menuitem"`
  - 为激活的菜单项添加 `aria-current="page"`
  - _需求: 需求7.4_

- [ ] 6.2 实现键盘导航
  - 支持 Tab 键在菜单项间移动
  - 支持 Enter/Space 键展开/收起父级菜单
  - 支持 Enter 键激活子菜单项
  - 支持 Arrow Up/Down 键在菜单项间移动
  - _需求: 需求7.1, 需求7.2, 需求7.3_

- [ ] 6.3 测试屏幕阅读器
  - 使用 NVDA/JAWS 测试菜单朗读
  - 验证菜单结构清晰
  - 验证状态变化能被正确通知
  - _需求: 需求7.5_

- [ ] 7. 样式优化和细节调整
  - 完善视觉效果
  - 确保与设计系统一致
  - _需求: 需求3_

- [ ] 7.1 完善父级菜单样式
  - 实现 hover 状态样式
  - 实现 expanded 状态样式
  - 实现 active 状态样式
  - 添加平滑过渡效果
  - _需求: 需求3.5_

- [ ] 7.2 完善子菜单样式
  - 添加左侧边框指示器
  - 实现缩进效果
  - 调整字体大小和颜色
  - 添加描述文本样式
  - _需求: 需求3.1, 需求3.2, 需求3.3_

- [ ] 7.3 响应式样式调整
  - 确保在不同屏幕尺寸下正常显示
  - 调整移动端的间距和字体
  - _需求: 需求4_

- [ ] 8. 性能优化
  - 优化渲染性能
  - 优化状态保存
  - _需求: 非功能需求_

- [ ] 8.1 实现防抖保存
  - 使用 lodash.debounce 或自定义防抖函数
  - 设置 300ms 延迟
  - 在组件卸载时清理定时器
  - _需求: 非功能需求 - 性能_

- [ ] 8.2 添加记忆化优化
  - 使用 useMemo 缓存计算结果
  - 使用 useCallback 缓存回调函数
  - 避免不必要的重新渲染
  - _需求: 非功能需求 - 性能_

- [ ] 8.3 优化条件渲染
  - 只在展开时渲染子菜单
  - 使用 AnimatePresence 优化动画性能
  - _需求: 非功能需求 - 性能_

- [ ] 9. 测试
  - 编写单元测试
  - 编写集成测试
  - 进行手动测试
  - _需求: 所有需求_

- [ ] 9.1 编写组件单元测试
  - 测试 SubmenuItem 组件渲染
  - 测试 MenuItemWithSubmenu 组件展开/收起
  - 测试状态管理逻辑
  - 测试路由匹配函数
  - _需求: 所有需求_

- [ ] 9.2 编写集成测试
  - 测试完整的导航流程
  - 测试状态持久化
  - 测试路由自动展开
  - 测试移动端交互
  - _需求: 所有需求_

- [ ] 9.3 手动测试
  - 在不同浏览器中测试（Chrome, Firefox, Safari, Edge）
  - 在不同设备上测试（桌面、平板、手机）
  - 测试键盘导航
  - 测试屏幕阅读器
  - _需求: 所有需求_

- [ ] 10. 文档和清理
  - 更新相关文档
  - 清理旧代码
  - _需求: 非功能需求_

- [ ] 10.1 更新组件文档
  - 为新组件添加 JSDoc 注释
  - 更新 README（如果有）
  - 添加使用示例
  - _需求: 非功能需求 - 可维护性_

- [ ] 10.2 清理和重构
  - 移除未使用的代码
  - 优化代码结构
  - 确保代码风格一致
  - _需求: 非功能需求 - 可维护性_

---

## 任务优先级

### P0 - 核心功能（必须完成）
- 任务 1: 准备工作和类型定义
- 任务 2: 创建子菜单组件
- 任务 3: 更新 AdminLayout 组件
- 任务 4: 实现路由匹配逻辑

### P1 - 重要功能（应该完成）
- 任务 5: 移动端适配
- 任务 7: 样式优化和细节调整
- 任务 9: 测试

### P2 - 可选功能（可以延后）
- 任务 6: 无障碍功能实现
- 任务 8: 性能优化
- 任务 10: 文档和清理

---

## 预估时间

- 任务 1: 0.5小时
- 任务 2: 2小时
- 任务 3: 2小时
- 任务 4: 1小时
- 任务 5: 1小时
- 任务 6: 1.5小时
- 任务 7: 1小时
- 任务 8: 1小时
- 任务 9: 2小时
- 任务 10: 0.5小时

**总计**: 约12.5小时

---

## 依赖关系

```
1 → 2 → 3 → 4 → 5
         ↓
         7 → 9 → 10
         ↓
         6 → 8
```

- 任务 2 依赖任务 1
- 任务 3 依赖任务 2
- 任务 4 依赖任务 3
- 任务 5, 6, 7, 8 可以并行进行（在任务 4 完成后）
- 任务 9 依赖所有功能任务完成
- 任务 10 依赖任务 9

---

## 验收标准

完成所有任务后，系统应该：

✅ 菜单结构清晰，"系统设置"下包含"网站配置"和"充值配置"  
✅ 点击父级菜单可以展开/收起子菜单  
✅ 子菜单有明显的视觉层次区分  
✅ 在移动端正常工作  
✅ 路由保持不变，可以直接访问配置页面  
✅ 刷新页面后菜单状态保持  
✅ 支持键盘导航  
✅ 动画流畅，性能良好  
✅ 通过所有测试用例  

---

**创建日期**: 2025-10-22  
**预计完成时间**: 1-2个工作日  
**状态**: 待开始
