<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æµ‹è¯•ç™»å½•å‰é€šçŸ¥</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #4CAF50;
      padding-bottom: 10px;
    }
    .section {
      margin: 30px 0;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 5px;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover {
      background: #45a049;
    }
    button.secondary {
      background: #2196F3;
    }
    button.secondary:hover {
      background: #0b7dda;
    }
    .result {
      margin-top: 20px;
      padding: 15px;
      background: #e8f5e9;
      border-left: 4px solid #4CAF50;
      border-radius: 4px;
      white-space: pre-wrap;
      font-family: monospace;
    }
    .error {
      background: #ffebee;
      border-left-color: #f44336;
    }
    .info {
      background: #e3f2fd;
      border-left-color: #2196F3;
    }
    input, textarea, select {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
      color: #555;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”” æµ‹è¯•ç™»å½•å‰é€šçŸ¥åŠŸèƒ½</h1>
    
    <div class="section">
      <h2>1. è·å–å…¬å¼€é€šçŸ¥ï¼ˆç™»å½•å‰ï¼‰</h2>
      <p>æµ‹è¯• <code>GET /api/notifications/public</code> ç«¯ç‚¹</p>
      <button onclick="getPublicNotifications()">è·å–å…¬å¼€é€šçŸ¥</button>
      <div id="publicResult"></div>
    </div>

    <div class="section">
      <h2>2. åˆ›å»ºç™»å½•å‰é€šçŸ¥ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰</h2>
      <form onsubmit="createNotification(event)">
        <label>æ ‡é¢˜:</label>
        <input type="text" id="title" value="æ¬¢è¿ä½¿ç”¨æˆ‘ä»¬çš„ç³»ç»Ÿ" required>
        
        <label>å†…å®¹:</label>
        <textarea id="content" rows="4" required>æ„Ÿè°¢æ‚¨é€‰æ‹©æˆ‘ä»¬çš„æœåŠ¡ï¼æˆ‘ä»¬è‡´åŠ›äºä¸ºæ‚¨æä¾›æœ€ä¼˜è´¨çš„ä½“éªŒã€‚</textarea>
        
        <label>æ˜¾ç¤ºæ—¶æœº:</label>
        <select id="showTiming">
          <option value="before_login">ç™»å½•å‰æ˜¾ç¤º</option>
          <option value="after_login">ç™»å½•åæ˜¾ç¤º</option>
        </select>
        
        <label>ä¼˜å…ˆçº§:</label>
        <select id="priority">
          <option value="low">ä½</option>
          <option value="normal">ä¸€èˆ¬</option>
          <option value="medium">ä¸­</option>
          <option value="high">é‡è¦</option>
          <option value="urgent">ç´§æ€¥</option>
        </select>
        
        <label>çŠ¶æ€:</label>
        <select id="status">
          <option value="draft">è‰ç¨¿</option>
          <option value="active">ç”Ÿæ•ˆä¸­</option>
          <option value="expired">å·²è¿‡æœŸ</option>
        </select>
        
        <label>ç›®æ ‡ç”¨æˆ·:</label>
        <select id="targetUsers">
          <option value="all">æ‰€æœ‰ç”¨æˆ·</option>
          <option value="vip">VIPç”¨æˆ·</option>
          <option value="normal">æ™®é€šç”¨æˆ·</option>
        </select>
        
        <br><br>
        <button type="submit">åˆ›å»ºé€šçŸ¥</button>
      </form>
      <div id="createResult"></div>
    </div>

    <div class="section">
      <h2>3. è·å–æ‰€æœ‰é€šçŸ¥ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰</h2>
      <button onclick="getAllNotifications()">è·å–æ‰€æœ‰é€šçŸ¥</button>
      <div id="allResult"></div>
    </div>

    <div class="section">
      <h2>4. æµ‹è¯•è¯´æ˜</h2>
      <ul>
        <li>âœ… å…¬å¼€é€šçŸ¥APIä¸éœ€è¦ç™»å½•å³å¯è®¿é—®</li>
        <li>âœ… åªè¿”å› <code>showTiming: 'before_login'</code> ä¸” <code>status: 'active'</code> çš„é€šçŸ¥</li>
        <li>âš ï¸ åˆ›å»ºé€šçŸ¥éœ€è¦ç®¡ç†å‘˜æƒé™ï¼ˆéœ€è¦å…ˆç™»å½•ç®¡ç†å‘˜è´¦å·ï¼‰</li>
        <li>ğŸ“ åˆ›å»ºé€šçŸ¥åï¼Œåˆ·æ–°ç™»å½•é¡µé¢åº”è¯¥èƒ½çœ‹åˆ°é€šçŸ¥å¼¹çª—</li>
      </ul>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;

    function getToken() {
      return document.cookie.split('token=')[1]?.split(';')[0] || '';
    }

    async function getPublicNotifications() {
      const resultDiv = document.getElementById('publicResult');
      resultDiv.innerHTML = '<div class="result info">æ­£åœ¨åŠ è½½...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/api/notifications/public`);
        const data = await response.json();
        
        console.log('å…¬å¼€é€šçŸ¥å“åº”:', data);
        
        if (data.success) {
          const notifications = data.data || [];
          resultDiv.innerHTML = `
            <div class="result">
              <strong>âœ… æˆåŠŸè·å– ${notifications.length} æ¡é€šçŸ¥</strong><br><br>
              ${notifications.length > 0 ? 
                notifications.map((n, i) => `
                  <strong>é€šçŸ¥ ${i + 1}:</strong><br>
                  - æ ‡é¢˜: ${n.title}<br>
                  - å†…å®¹: ${n.content}<br>
                  - æ˜¾ç¤ºæ—¶æœº: ${n.showTiming}<br>
                  - ä¼˜å…ˆçº§: ${n.priority}<br>
                  - çŠ¶æ€: ${n.status}<br>
                  - å¼€å§‹æ—¥æœŸ: ${n.startDate}<br>
                  - ç»“æŸæ—¥æœŸ: ${n.endDate || 'æ°¸ä¹…'}<br>
                  <br>
                `).join('') 
                : 'æš‚æ— ç™»å½•å‰é€šçŸ¥'
              }
            </div>
          `;
        } else {
          resultDiv.innerHTML = `<div class="result error">âŒ ${data.message}</div>`;
        }
      } catch (error) {
        resultDiv.innerHTML = `<div class="result error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
        console.error('è·å–å…¬å¼€é€šçŸ¥å¤±è´¥:', error);
      }
    }

    async function createNotification(event) {
      event.preventDefault();
      
      const resultDiv = document.getElementById('createResult');
      resultDiv.innerHTML = '<div class="result info">æ­£åœ¨åˆ›å»º...</div>';
      
      const token = getToken();
      if (!token) {
        resultDiv.innerHTML = '<div class="result error">âŒ æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•ç®¡ç†å‘˜è´¦å·</div>';
        return;
      }
      
      const notificationData = {
        title: document.getElementById('title').value,
        content: document.getElementById('content').value,
        type: 'text',
        showTiming: document.getElementById('showTiming').value,
        priority: document.getElementById('priority').value,
        status: document.getElementById('status').value,
        targetUsers: document.getElementById('targetUsers').value,
        startDate: new Date().toISOString().split('T')[0],
        endDate: ''
      };
      
      try {
        const response = await fetch(`${API_BASE}/api/notifications`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          credentials: 'include',
          body: JSON.stringify(notificationData)
        });
        
        const data = await response.json();
        console.log('åˆ›å»ºé€šçŸ¥å“åº”:', data);
        
        if (data.success) {
          resultDiv.innerHTML = `
            <div class="result">
              <strong>âœ… é€šçŸ¥åˆ›å»ºæˆåŠŸï¼</strong><br><br>
              é€šçŸ¥ID: ${data.data._id}<br>
              æ ‡é¢˜: ${data.data.title}<br>
              æ˜¾ç¤ºæ—¶æœº: ${data.data.showTiming}<br>
              çŠ¶æ€: ${data.data.status}<br><br>
              <strong>ğŸ’¡ æç¤º:</strong> åˆ·æ–°ç™»å½•é¡µé¢æŸ¥çœ‹æ•ˆæœ
            </div>
          `;
        } else {
          resultDiv.innerHTML = `<div class="result error">âŒ ${data.message}</div>`;
        }
      } catch (error) {
        resultDiv.innerHTML = `<div class="result error">âŒ åˆ›å»ºå¤±è´¥: ${error.message}</div>`;
        console.error('åˆ›å»ºé€šçŸ¥å¤±è´¥:', error);
      }
    }

    async function getAllNotifications() {
      const resultDiv = document.getElementById('allResult');
      resultDiv.innerHTML = '<div class="result info">æ­£åœ¨åŠ è½½...</div>';
      
      const token = getToken();
      if (!token) {
        resultDiv.innerHTML = '<div class="result error">âŒ æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•ç®¡ç†å‘˜è´¦å·</div>';
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/api/notifications?limit=100`, {
          headers: {
            'Authorization': `Bearer ${token}`
          },
          credentials: 'include'
        });
        
        const data = await response.json();
        console.log('æ‰€æœ‰é€šçŸ¥å“åº”:', data);
        
        if (data.success) {
          const notifications = data.data.notifications || [];
          const beforeLogin = notifications.filter(n => n.showTiming === 'before_login');
          const afterLogin = notifications.filter(n => n.showTiming === 'after_login' || !n.showTiming);
          
          resultDiv.innerHTML = `
            <div class="result">
              <strong>âœ… æ€»é€šçŸ¥æ•°: ${notifications.length}</strong><br>
              - ç™»å½•å‰æ˜¾ç¤º: ${beforeLogin.length} æ¡<br>
              - ç™»å½•åæ˜¾ç¤º: ${afterLogin.length} æ¡<br><br>
              
              <strong>ç™»å½•å‰é€šçŸ¥åˆ—è¡¨:</strong><br>
              ${beforeLogin.length > 0 ? 
                beforeLogin.map((n, i) => `
                  ${i + 1}. ${n.title} (${n.status}) - ä¼˜å…ˆçº§: ${n.priority}<br>
                `).join('') 
                : 'æš‚æ— <br>'
              }
              <br>
              <strong>ç™»å½•åé€šçŸ¥åˆ—è¡¨:</strong><br>
              ${afterLogin.length > 0 ? 
                afterLogin.map((n, i) => `
                  ${i + 1}. ${n.title} (${n.status}) - ä¼˜å…ˆçº§: ${n.priority}<br>
                `).join('') 
                : 'æš‚æ— <br>'
              }
            </div>
          `;
        } else {
          resultDiv.innerHTML = `<div class="result error">âŒ ${data.message}</div>`;
        }
      } catch (error) {
        resultDiv.innerHTML = `<div class="result error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
        console.error('è·å–æ‰€æœ‰é€šçŸ¥å¤±è´¥:', error);
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•å…¬å¼€API
    window.onload = () => {
      console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œè‡ªåŠ¨æµ‹è¯•å…¬å¼€é€šçŸ¥API...');
      getPublicNotifications();
    };
  </script>
</body>
</html>
