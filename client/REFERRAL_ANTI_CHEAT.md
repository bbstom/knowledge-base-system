# é‚€è¯·ç åä½œå¼Šç³»ç»Ÿ

## ğŸ›¡ï¸ ç»¼åˆåä½œå¼Šæœºåˆ¶

ç³»ç»Ÿå®æ–½äº†å¤šå±‚åä½œå¼Šæ£€æµ‹ï¼Œé˜²æ­¢ç”¨æˆ·é€šè¿‡é‚€è¯·ç åˆ·ç§¯åˆ†ã€‚

## ğŸ” æ£€æµ‹æœºåˆ¶

### 1. IPåœ°å€æ£€æµ‹ â­â­â­â­â­

#### 1.1 åŒä¸€IPé™åˆ¶
```
åŒä¸€IPåœ°å€24å°æ—¶å†…ï¼š
- ä½¿ç”¨åŒä¸€é‚€è¯·ç æ³¨å†Œï¼šæœ€å¤š2ä¸ªè´¦æˆ·
- è¶…è¿‡é™åˆ¶ï¼šæ‹’ç»æ³¨å†Œ
```

**åœºæ™¯**ï¼š
```
ç”¨æˆ·Açš„é‚€è¯·ç : ABC123
IP: 192.168.1.100

æ³¨å†Œ1: test1@example.com (IP: 192.168.1.100) âœ… å…è®¸
æ³¨å†Œ2: test2@example.com (IP: 192.168.1.100) âœ… å…è®¸
æ³¨å†Œ3: test3@example.com (IP: 192.168.1.100) âŒ æ‹’ç»
```

#### 1.2 æ¨èäººIPæ£€æµ‹
```
å¦‚æœæ¨èäººå’Œæ–°ç”¨æˆ·ä½¿ç”¨ç›¸åŒIPï¼š
- ç›´æ¥æ‹’ç»æ³¨å†Œ
- é˜²æ­¢è‡ªå·±æ¨èè‡ªå·±
```

**åœºæ™¯**ï¼š
```
ç”¨æˆ·A (IP: 192.168.1.100) çš„é‚€è¯·ç : ABC123
ç”¨æˆ·B (IP: 192.168.1.100) å°è¯•ä½¿ç”¨ ABC123 æ³¨å†Œ
ç»“æœ: âŒ æ‹’ç» - "æ£€æµ‹åˆ°å¼‚å¸¸æ³¨å†Œè¡Œä¸º"
```

### 2. é‚®ç®±æ¨¡å¼æ£€æµ‹ â­â­â­â­

#### 2.1 ç›¸ä¼¼é‚®ç®±æ£€æµ‹
```
æ£€æµ‹æ‰¹é‡æ³¨å†Œçš„ç›¸ä¼¼é‚®ç®±ï¼š
- test1@example.com
- test2@example.com
- test3@example.com

24å°æ—¶å†…åŒä¸€é‚€è¯·ç ï¼š
- ç›¸ä¼¼é‚®ç®±æœ€å¤š2ä¸ª
- è¶…è¿‡é™åˆ¶ï¼šæ‹’ç»æ³¨å†Œ
```

**æ£€æµ‹é€»è¾‘**ï¼š
```javascript
// æå–é‚®ç®±å‰ç¼€ï¼ˆç§»é™¤æœ«å°¾æ•°å­—ï¼‰
test1@example.com â†’ test
test2@example.com â†’ test
test3@example.com â†’ test

// å¦‚æœç›¸ä¼¼é‚®ç®± >= 2ï¼Œæ‹’ç»æ³¨å†Œ
```

#### 2.2 ä¸´æ—¶é‚®ç®±æ£€æµ‹
```
æ‹’ç»ä»¥ä¸‹ä¸´æ—¶é‚®ç®±åŸŸåï¼š
- tempmail.com
- guerrillamail.com
- 10minutemail.com
- throwaway.email
- mailinator.com
- trashmail.com
```

### 3. IPé¢‘ç‡é™åˆ¶ï¼ˆå·²æœ‰ï¼‰ â­â­â­

```
åŒä¸€IPåœ°å€ï¼š
- æ¯å°æ—¶æœ€å¤šæ³¨å†Œ5ä¸ªè´¦æˆ·ï¼ˆä»»ä½•é‚€è¯·ç ï¼‰
- è¿™æ˜¯å…¨å±€é™åˆ¶ï¼Œä¸é’ˆå¯¹ç‰¹å®šé‚€è¯·ç 
```

## ğŸ“Š åä½œå¼Šè§„åˆ™æ€»ç»“

| æ£€æµ‹é¡¹ | é™åˆ¶ | æ—¶é—´çª—å£ | ä¼˜å…ˆçº§ |
|--------|------|---------|--------|
| æ¨èäººIP = æ–°ç”¨æˆ·IP | ç¦æ­¢ | æ°¸ä¹… | â­â­â­â­â­ |
| åŒä¸€IPä½¿ç”¨åŒä¸€é‚€è¯·ç  | 2æ¬¡ | 24å°æ—¶ | â­â­â­â­â­ |
| ç›¸ä¼¼é‚®ç®±æ¨¡å¼ | 2æ¬¡ | 24å°æ—¶ | â­â­â­â­ |
| ä¸´æ—¶é‚®ç®± | ç¦æ­¢ | æ°¸ä¹… | â­â­â­ |
| å…¨å±€IPæ³¨å†Œé™åˆ¶ | 5æ¬¡ | 1å°æ—¶ | â­â­â­ |

## ğŸ¯ ä½œå¼Šåœºæ™¯åˆ†æ

### åœºæ™¯1ï¼šè‡ªå·±æ¨èè‡ªå·±
```
ç”¨æˆ·A (IP: 192.168.1.100)
é‚€è¯·ç : ABC123

å°è¯•ï¼š
- ä½¿ç”¨ABC123åœ¨åŒä¸€IPæ³¨å†Œæ–°è´¦æˆ·

ç»“æœï¼š
âŒ æ‹’ç» - "æ£€æµ‹åˆ°å¼‚å¸¸æ³¨å†Œè¡Œä¸ºï¼Œæ— æ³•ä½¿ç”¨è¯¥é‚€è¯·ç "

åŸå› ï¼š
æ¨èäººIPå’Œæ–°ç”¨æˆ·IPç›¸åŒ
```

### åœºæ™¯2ï¼šç›¸ä¼¼é‚®ç®±æ‰¹é‡æ³¨å†Œ
```
ç”¨æˆ·Açš„é‚€è¯·ç : ABC123

å°è¯•æ³¨å†Œï¼š
1. user1@gmail.com âœ… æˆåŠŸ
2. user2@gmail.com âœ… æˆåŠŸ
3. user3@gmail.com âŒ æ‹’ç» - "æ£€æµ‹åˆ°å¼‚å¸¸æ³¨å†Œè¡Œä¸ºï¼Œè¯·ä½¿ç”¨çœŸå®é‚®ç®±"

åŸå› ï¼š
æ£€æµ‹åˆ°ç›¸ä¼¼é‚®ç®±æ¨¡å¼ user*@gmail.com
```

### åœºæ™¯3ï¼šä½¿ç”¨ä¸´æ—¶é‚®ç®±
```
å°è¯•æ³¨å†Œï¼š
test@tempmail.com

ç»“æœï¼š
âŒ æ‹’ç» - "è¯·ä½¿ç”¨çœŸå®é‚®ç®±æ³¨å†Œ"

åŸå› ï¼š
æ£€æµ‹åˆ°ä¸´æ—¶é‚®ç®±åŸŸå
```

## ğŸ”§ æŠ€æœ¯å®ç°

### æ–‡ä»¶ç»“æ„
```
server/
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ antiCheat.js          # åä½œå¼Šæ£€æµ‹å·¥å…·
â”œâ”€â”€ models/
â”‚   â””â”€â”€ User.js               # æ·»åŠ  registrationIp å’Œ security å­—æ®µ
â””â”€â”€ routes/
    â””â”€â”€ auth.js               # åº”ç”¨åä½œå¼Šæ£€æµ‹
```

### æ ¸å¿ƒå‡½æ•°

#### 1. detectReferralCheat()
```javascript
// æ£€æµ‹é‚€è¯·ç ä½œå¼Š
const result = await detectReferralCheat({
  referrerId: 'æ¨èäººID',
  newUserEmail: 'æ–°ç”¨æˆ·é‚®ç®±',
  newUserIp: 'æ–°ç”¨æˆ·IP'
});

// è¿”å›: { allowed: true/false, reason: 'åŸå› ' }
```

#### 2. shouldDelayReferralReward()
```javascript
// æ£€æµ‹æ˜¯å¦åº”è¯¥å»¶è¿Ÿå‘æ”¾å¥–åŠ±
const result = await shouldDelayReferralReward(
  'æ¨èäººID',
  'æ–°ç”¨æˆ·ID'
);

// è¿”å›: { shouldDelay: true/false, reason: 'åŸå› ' }
```

### æ•°æ®åº“å­—æ®µ

#### Useræ¨¡å‹æ–°å¢å­—æ®µ
```javascript
{
  registrationIp: String,      // æ³¨å†ŒIPåœ°å€
  security: {
    suspicious: Boolean,       // æ˜¯å¦å¯ç–‘
    suspiciousReason: String,  // å¯ç–‘åŸå› 
    suspiciousAt: Date        // æ ‡è®°æ—¶é—´
  }
}
```

## ğŸ”„ éœ€è¦é‡å¯åç«¯

ä¿®æ”¹äº†æ¨¡å‹å’Œè·¯ç”±ï¼Œéœ€è¦é‡å¯ï¼š

```bash
# åœæ­¢åç«¯
Ctrl+C

# é‡å¯åç«¯
cd server
npm run dev
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•1ï¼šæ­£å¸¸æ¨è
```bash
# ç”¨æˆ·Aæ³¨å†Œ
curl -X POST http://localhost:3001/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "userA",
    "email": "userA@example.com",
    "password": "password123"
  }'

# è·å–ç”¨æˆ·Açš„é‚€è¯·ç ï¼ˆå‡è®¾æ˜¯ABC123ï¼‰

# ç”¨æˆ·Bä½¿ç”¨é‚€è¯·ç æ³¨å†Œï¼ˆä¸åŒIPï¼‰
curl -X POST http://localhost:3001/api/auth/register \
  -H "Content-Type: application/json" \
  -H "X-Forwarded-For: 192.168.1.200" \
  -d '{
    "username": "userB",
    "email": "userB@example.com",
    "password": "password123",
    "referralCode": "ABC123"
  }'

# åº”è¯¥æˆåŠŸ âœ…
```

### æµ‹è¯•2ï¼šåŒIPè‡ªå·±æ¨èè‡ªå·±
```bash
# ç”¨æˆ·Aå°è¯•ç”¨è‡ªå·±çš„é‚€è¯·ç æ³¨å†Œæ–°è´¦æˆ·ï¼ˆåŒIPï¼‰
curl -X POST http://localhost:3001/api/auth/register \
  -H "Content-Type: application/json" \
  -H "X-Forwarded-For: 192.168.1.100" \
  -d '{
    "username": "userC",
    "email": "userC@example.com",
    "password": "password123",
    "referralCode": "ABC123"
  }'

# åº”è¯¥å¤±è´¥ âŒ - "æ£€æµ‹åˆ°å¼‚å¸¸æ³¨å†Œè¡Œä¸º"
```

### æµ‹è¯•3ï¼šç›¸ä¼¼é‚®ç®±æ‰¹é‡æ³¨å†Œ
```bash
# ä½¿ç”¨ç›¸ä¼¼é‚®ç®±æ³¨å†Œ3æ¬¡
for i in {1..3}; do
  curl -X POST http://localhost:3001/api/auth/register \
    -H "Content-Type: application/json" \
    -H "X-Forwarded-For: 192.168.1.$((200+i))" \
    -d "{
      \"username\": \"test$i\",
      \"email\": \"test$i@example.com\",
      \"password\": \"password123\",
      \"referralCode\": \"ABC123\"
    }"
  echo ""
done

# å‰2æ¬¡åº”è¯¥æˆåŠŸï¼Œç¬¬3æ¬¡åº”è¯¥å¤±è´¥ï¼ˆç›¸ä¼¼é‚®ç®±æ¨¡å¼ï¼‰
```

## ğŸ“Š ç›‘æ§å’Œç®¡ç†

### æŸ¥çœ‹å¯ç–‘ç”¨æˆ·
```javascript
// åœ¨MongoDBä¸­æŸ¥è¯¢
db.users.find({ 
  "security.suspicious": true 
})

// æŸ¥çœ‹ç‰¹å®šç”¨æˆ·çš„æ³¨å†ŒIP
db.users.find({ 
  registrationIp: "192.168.1.100" 
})

// æŸ¥çœ‹æŸä¸ªæ¨èäººçš„æ‰€æœ‰è¢«æ¨èç”¨æˆ·
db.users.find({ 
  referredBy: ObjectId("æ¨èäººID") 
}).sort({ createdAt: -1 })
```

### æ¸…é™¤å¯ç–‘æ ‡è®°
```javascript
// å¦‚æœè¯¯åˆ¤ï¼Œå¯ä»¥æ¸…é™¤å¯ç–‘æ ‡è®°
db.users.updateOne(
  { _id: ObjectId("ç”¨æˆ·ID") },
  { 
    $set: { 
      "security.suspicious": false,
      "security.suspiciousReason": null
    } 
  }
)
```

## ğŸ’¡ è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### 1. é‚®ç®±éªŒè¯ï¼ˆæ¨èï¼‰â­â­â­â­â­
```
è¦æ±‚ï¼š
- æ³¨å†Œåå¿…é¡»éªŒè¯é‚®ç®±
- åªæœ‰éªŒè¯é‚®ç®±åæ‰å‘æ”¾æ¨èå¥–åŠ±
- å¤§å¹…é™ä½æ‰¹é‡æ³¨å†Œæˆæœ¬
```

### 2. é¦–æ¬¡å……å€¼éªŒè¯ï¼ˆæ¨èï¼‰â­â­â­â­
```
è¦æ±‚ï¼š
- æ–°ç”¨æˆ·å®Œæˆé¦–æ¬¡å……å€¼åæ‰å‘æ”¾æ¨èå¥–åŠ±
- æˆ–è€…å»¶è¿Ÿ7å¤©åå‘æ”¾
- é˜²æ­¢æ³¨å†Œåç«‹å³æç°
```

### 3. è¡Œä¸ºéªŒè¯ï¼ˆå¯é€‰ï¼‰â­â­â­
```
è¦æ±‚ï¼š
- æ–°ç”¨æˆ·å®Œæˆä¸€å®šæ“ä½œåæ‰å‘æ”¾å¥–åŠ±
- å¦‚ï¼šå®Œæˆé¦–æ¬¡æœç´¢ã€å®Œå–„ä¸ªäººèµ„æ–™ç­‰
```

### 4. æ‰‹æœºéªŒè¯ï¼ˆå¯é€‰ï¼‰â­â­â­
```
è¦æ±‚ï¼š
- ç»‘å®šæ‰‹æœºå·
- å‘é€çŸ­ä¿¡éªŒè¯ç 
- æˆæœ¬è¾ƒé«˜ä½†æ•ˆæœå¥½
```

### 5. è®¾å¤‡æŒ‡çº¹ï¼ˆé«˜çº§ï¼‰â­â­â­â­
```
è¦æ±‚ï¼š
- æ”¶é›†æµè§ˆå™¨æŒ‡çº¹
- æ£€æµ‹åŒä¸€è®¾å¤‡çš„å¤šæ¬¡æ³¨å†Œ
- éœ€è¦å‰ç«¯é…åˆ
```

## âœ… æ€»ç»“

**ç°åœ¨ç³»ç»Ÿæœ‰å¤šå±‚é˜²æŠ¤**ï¼š

1. âœ… IPåœ°å€æ£€æµ‹ï¼ˆæ¨èäººIP â‰  æ–°ç”¨æˆ·IPï¼‰
2. âœ… åŒIPé™åˆ¶ï¼ˆ24å°æ—¶å†…æœ€å¤š2æ¬¡ï¼‰
3. âœ… ç›¸ä¼¼é‚®ç®±æ£€æµ‹ï¼ˆé˜²æ­¢æ‰¹é‡æ³¨å†Œï¼‰
4. âœ… ä¸´æ—¶é‚®ç®±æ‹¦æˆª
5. âœ… å…¨å±€IPé™åˆ¶ï¼ˆæ¯å°æ—¶5æ¬¡ï¼‰

**è¿™äº›æœºåˆ¶å¯ä»¥æœ‰æ•ˆé˜²æ­¢**ï¼š
- âŒ è‡ªå·±æ¨èè‡ªå·±
- âŒ åŒIPæ‰¹é‡æ³¨å†Œ
- âŒ ä½¿ç”¨ä¸´æ—¶é‚®ç®±
- âŒ ç›¸ä¼¼é‚®ç®±æ‰¹é‡æ³¨å†Œ

**é‡å¯åç«¯åå³å¯ç”Ÿæ•ˆï¼** ğŸ›¡ï¸
