# å¿«é€Ÿä¿®å¤ aabbk@gmail.com ç”¨æˆ·ç§¯åˆ†è®°å½•

## é—®é¢˜
æµ‹è¯•ç”¨æˆ· `aabbk@gmail.com` çœ‹ä¸åˆ°æ³¨å†Œæ—¶çš„ç§¯åˆ†è®°å½•ã€‚

## åŸå› 
è¯¥ç”¨æˆ·åœ¨ä»£ç ä¿®å¤å‰æ³¨å†Œï¼Œå½“æ—¶æ³¨å†Œæµç¨‹æ²¡æœ‰åˆ›å»ºBalanceLogè®°å½•ã€‚

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šè¿è¡Œè¡¥å……è„šæœ¬ï¼ˆæ¨èï¼‰

å·²åˆ›å»ºè„šæœ¬ï¼š`server/scripts/backfillSingleUser.js`

è¿è¡Œå‘½ä»¤ï¼š
```bash
node server/scripts/backfillSingleUser.js
```

è¯¥è„šæœ¬ä¼šï¼š
1. æŸ¥æ‰¾ aabbk@gmail.com ç”¨æˆ·
2. æ£€æŸ¥æ˜¯å¦å·²æœ‰ç§¯åˆ†è®°å½•
3. å¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºä¸€æ¡"æ³¨å†Œå¥–åŠ±ï¼ˆè¡¥å½•ï¼‰"è®°å½•
4. ä½¿ç”¨ç”¨æˆ·çš„æ³¨å†Œæ—¶é—´ä½œä¸ºè®°å½•æ—¶é—´

### æ–¹æ¡ˆ2ï¼šä½¿ç”¨MongoDBå‘½ä»¤è¡Œ

```bash
# 1. è¿æ¥MongoDB
mongo knowbase

# 2. æŸ¥æ‰¾ç”¨æˆ·ä¿¡æ¯
db.users.findOne({ email: "aabbk@gmail.com" })

# 3. è®°å½•ç”¨æˆ·IDå’Œç§¯åˆ†ï¼ˆä»ä¸Šä¸€æ­¥çš„è¾“å‡ºä¸­è·å–ï¼‰
# å‡è®¾ï¼š
# _id: ObjectId("67890abcdef12345")
# points: 100
# createdAt: ISODate("2024-10-23T10:00:00Z")

# 4. åˆ›å»ºç§¯åˆ†è®°å½•
db.balancelogs.insertOne({
  userId: ObjectId("67890abcdef12345"),  // æ›¿æ¢ä¸ºå®é™…ID
  type: "register",
  currency: "points",
  amount: 100,  // æ›¿æ¢ä¸ºå®é™…ç§¯åˆ†
  balanceBefore: 0,
  balanceAfter: 100,  // æ›¿æ¢ä¸ºå®é™…ç§¯åˆ†
  description: "æ³¨å†Œå¥–åŠ±ï¼ˆè¡¥å½•ï¼‰",
  createdAt: ISODate("2024-10-23T10:00:00Z")  // æ›¿æ¢ä¸ºå®é™…æ³¨å†Œæ—¶é—´
})

# 5. éªŒè¯
db.balancelogs.find({ 
  userId: ObjectId("67890abcdef12345"),
  currency: "points"
})
```

### æ–¹æ¡ˆ3ï¼šé‡æ–°æ³¨å†Œï¼ˆæœ€ç®€å•ï¼‰

1. åˆ é™¤æµ‹è¯•ç”¨æˆ·
```bash
mongo knowbase
db.users.deleteOne({ email: "aabbk@gmail.com" })
```

2. ç¡®ä¿æœåŠ¡å™¨å·²é‡å¯

3. é‡æ–°æ³¨å†Œ aabbk@gmail.com

4. æ–°æ³¨å†Œä¼šè‡ªåŠ¨åˆ›å»ºç§¯åˆ†è®°å½•

## éªŒè¯

è¡¥å……è®°å½•åï¼Œç”¨æˆ·ç™»å½•åº”è¯¥èƒ½çœ‹åˆ°ï¼š

**ç§¯åˆ†ä¸­å¿ƒ â†’ ç§¯åˆ†å†å²**
- ç±»å‹ï¼šå¥–åŠ±
- é‡‘é¢ï¼š+100ç§¯åˆ†
- æè¿°ï¼šæ³¨å†Œå¥–åŠ±ï¼ˆè¡¥å½•ï¼‰
- æ—¶é—´ï¼šç”¨æˆ·æ³¨å†Œæ—¶é—´

## æœªæ¥ç”¨æˆ·

ä¿®å¤åæ³¨å†Œçš„æ–°ç”¨æˆ·ä¼šè‡ªåŠ¨åˆ›å»ºç§¯åˆ†è®°å½•ï¼Œä¸éœ€è¦æ‰‹åŠ¨è¡¥å……ã€‚

## æ³¨æ„äº‹é¡¹

1. **æœåŠ¡å™¨å¿…é¡»å·²é‡å¯**
   - ç¡®ä¿ä»£ç ä¿®æ”¹å·²ç”Ÿæ•ˆ

2. **åªéœ€è¡¥å……ä¸€æ¬¡**
   - è„šæœ¬ä¼šæ£€æŸ¥æ˜¯å¦å·²æœ‰è®°å½•
   - é¿å…é‡å¤åˆ›å»º

3. **å†å²ç”¨æˆ·éƒ½éœ€è¦è¡¥å……**
   - å¦‚æœæœ‰å¤šä¸ªå†å²ç”¨æˆ·
   - å¯ä»¥ä¿®æ”¹è„šæœ¬æ‰¹é‡å¤„ç†

## æ‰¹é‡è¡¥å……æ‰€æœ‰å†å²ç”¨æˆ·

å¦‚æœéœ€è¦ä¸ºæ‰€æœ‰å†å²ç”¨æˆ·è¡¥å……è®°å½•ï¼Œä¿®æ”¹è„šæœ¬ï¼š

```javascript
// æŸ¥æ‰¾æ‰€æœ‰æœ‰ç§¯åˆ†ä½†æ²¡æœ‰è®°å½•çš„ç”¨æˆ·
const users = await User.find({ points: { $gt: 0 } });

for (const user of users) {
  const hasLog = await BalanceLog.findOne({
    userId: user._id,
    currency: 'points'
  });

  if (!hasLog) {
    await BalanceLog.create({
      userId: user._id,
      type: 'register',
      currency: 'points',
      amount: user.points,
      balanceBefore: 0,
      balanceAfter: user.points,
      description: 'æ³¨å†Œå¥–åŠ±ï¼ˆè¡¥å½•ï¼‰',
      createdAt: user.createdAt
    });
    console.log(`âœ… ${user.username}`);
  }
}
```

## æ€»ç»“

- âœ… ä»£ç å·²ä¿®å¤
- âœ… è¡¥å……è„šæœ¬å·²åˆ›å»º
- âš ï¸ éœ€è¦æ‰‹åŠ¨è¿è¡Œè„šæœ¬è¡¥å……å†å²ç”¨æˆ·è®°å½•
- ğŸ‰ æ–°ç”¨æˆ·ä¼šè‡ªåŠ¨åˆ›å»ºè®°å½•
