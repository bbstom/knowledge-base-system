# IPæ³¨å†Œé¢‘ç‡é™åˆ¶

## âœ… å·²æ·»åŠ IPæ³¨å†Œé™åˆ¶

ç³»ç»Ÿç°åœ¨å¯ä»¥é˜²æ­¢åŒä¸€IPé¢‘ç¹æ³¨å†Œè´¦æˆ·ã€‚

## ğŸ›¡ï¸ é™åˆ¶è§„åˆ™

### æ³¨å†Œé¢‘ç‡é™åˆ¶

| é™åˆ¶ç±»å‹ | é™åˆ¶æ¬¡æ•° | æ—¶é—´çª—å£ | è¯´æ˜ |
|---------|---------|---------|------|
| **åŒä¸€IP** | 2æ¬¡ | 3å°æ—¶ | é˜²æ­¢æ‰¹é‡æ³¨å†Œ |
| **åŒä¸€é‚®ç®±** | 2æ¬¡ | 24å°æ—¶ | é˜²æ­¢é‡å¤å°è¯• |

### å…·ä½“è§„åˆ™

#### 1. IPé™åˆ¶ï¼ˆæ›´æ–°ï¼‰
```
åŒä¸€IPåœ°å€ï¼š
- 3å°æ—¶å†…æœ€å¤šæ³¨å†Œ 2 ä¸ªè´¦æˆ·
- è¶…è¿‡é™åˆ¶åéœ€è¦ç­‰å¾… 3 å°æ—¶
- 3å°æ—¶åè‡ªåŠ¨é‡ç½®è®¡æ•°å™¨
- é€‚ç”¨äºæ‰€æœ‰IPåœ°å€
```

#### 2. é‚®ç®±é™åˆ¶ï¼ˆæ›´æ–°ï¼‰
```
åŒä¸€é‚®ç®±åœ°å€ï¼š
- æ¯å¤©æœ€å¤šå°è¯•æ³¨å†Œ 2 æ¬¡
- è¶…è¿‡é™åˆ¶åéœ€è¦ç­‰å¾… 24 å°æ—¶
- é˜²æ­¢æ¶æ„å ç”¨é‚®ç®±
```

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. é¢‘ç‡é™åˆ¶ä¸­é—´ä»¶
**æ–‡ä»¶**: `server/middleware/rateLimit.js`

```javascript
const RATE_LIMITS = {
  register: {
    email: { max: 3, window: 24 * 60 * 60 * 1000 }, // æ¯å¤©3æ¬¡
    ip: { max: 5, window: 60 * 60 * 1000 }          // æ¯å°æ—¶5æ¬¡
  }
};
```

### 2. åº”ç”¨åˆ°æ³¨å†Œæ¥å£
**æ–‡ä»¶**: `server/routes/auth.js`

```javascript
const { rateLimitMiddleware } = require('../middleware/rateLimit');

router.post('/register', rateLimitMiddleware('register'), async (req, res) => {
  // æ³¨å†Œé€»è¾‘
});
```

### 3. IPè·å–é€»è¾‘
ç³»ç»Ÿä¼šæŒ‰ä¼˜å…ˆçº§è·å–çœŸå®IPï¼š

```javascript
const getClientIP = (req) => {
  return req.headers['x-forwarded-for']?.split(',')[0] ||  // Nginxä»£ç†
         req.headers['x-real-ip'] ||                       // å…¶ä»–ä»£ç†
         req.connection.remoteAddress ||                   // ç›´è¿
         req.socket.remoteAddress ||
         req.ip;
};
```

## ğŸ“Š é™åˆ¶æ•ˆæœ

### åœºæ™¯1ï¼šæ­£å¸¸ç”¨æˆ·
```
ç”¨æˆ·A (IP: 192.168.1.100):
- ç¬¬1æ¬¡æ³¨å†Œ: âœ… æˆåŠŸ
- 1å°æ—¶å†…ä¸ä¼šå†æ³¨å†Œ
```

### åœºæ™¯2ï¼šæ‰¹é‡æ³¨å†Œ
```
æ¶æ„ç”¨æˆ· (IP: 192.168.1.200):
- ç¬¬1æ¬¡æ³¨å†Œ: âœ… æˆåŠŸ
- ç¬¬2æ¬¡æ³¨å†Œ: âœ… æˆåŠŸ
- ç¬¬3æ¬¡æ³¨å†Œ: âœ… æˆåŠŸ
- ç¬¬4æ¬¡æ³¨å†Œ: âœ… æˆåŠŸ
- ç¬¬5æ¬¡æ³¨å†Œ: âœ… æˆåŠŸ
- ç¬¬6æ¬¡æ³¨å†Œ: âŒ å¤±è´¥ - "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•"
- éœ€è¦ç­‰å¾…1å°æ—¶åæ‰èƒ½ç»§ç»­
```

### åœºæ™¯3ï¼šåŒä¸€é‚®ç®±é‡å¤æ³¨å†Œ
```
ç”¨æˆ·å°è¯•æ³¨å†Œ test@example.com:
- ç¬¬1æ¬¡: âœ… æˆåŠŸï¼ˆæˆ–å¤±è´¥ï¼‰
- ç¬¬2æ¬¡: âœ… å…è®¸é‡è¯•
- ç¬¬3æ¬¡: âœ… å…è®¸é‡è¯•
- ç¬¬4æ¬¡: âŒ å¤±è´¥ - "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•"
- éœ€è¦ç­‰å¾…24å°æ—¶
```

## ğŸ” é”™è¯¯æç¤º

### è¶…è¿‡IPé™åˆ¶
```json
{
  "success": false,
  "message": "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·1å°æ—¶åå†è¯•",
  "resetIn": 3456  // å‰©ä½™ç§’æ•°
}
```

### è¶…è¿‡é‚®ç®±é™åˆ¶
```json
{
  "success": false,
  "message": "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·24å°æ—¶åå†è¯•",
  "resetIn": 86234  // å‰©ä½™ç§’æ•°
}
```

## ğŸ“ æ•°æ®åº“è®°å½•

### RateLimitæ¨¡å‹
ç³»ç»Ÿä¼šåœ¨æ•°æ®åº“ä¸­è®°å½•æ¯æ¬¡è¯·æ±‚ï¼š

```javascript
{
  identifier: "192.168.1.100",  // IPåœ°å€æˆ–é‚®ç®±
  type: "ip",                   // ç±»å‹ï¼šip æˆ– email
  action: "register",           // æ“ä½œï¼šregister
  count: 3,                     // å½“å‰è®¡æ•°
  windowStart: "2024-11-16T10:00:00Z",  // çª—å£å¼€å§‹æ—¶é—´
  expiresAt: "2024-11-16T11:00:00Z"     // è¿‡æœŸæ—¶é—´
}
```

### è‡ªåŠ¨æ¸…ç†
- è¿‡æœŸè®°å½•ä¼šè‡ªåŠ¨æ¸…ç†
- ä¸å ç”¨è¿‡å¤šå­˜å‚¨ç©ºé—´
- ä¿æŒæ•°æ®åº“æ€§èƒ½

## ğŸ¯ å…¶ä»–æ¥å£çš„é™åˆ¶

ç³»ç»Ÿè¿˜å¯¹å…¶ä»–æ¥å£è¿›è¡Œäº†é¢‘ç‡é™åˆ¶ï¼š

| æ¥å£ | IPé™åˆ¶ | é‚®ç®±é™åˆ¶ | æ—¶é—´çª—å£ |
|------|--------|---------|---------|
| æ³¨å†Œ | 5æ¬¡ | 3æ¬¡ | 1å°æ—¶/24å°æ—¶ |
| å‘é€éªŒè¯ç  | 10æ¬¡ | 5æ¬¡ | 1å°æ—¶ |
| éªŒè¯ç éªŒè¯ | 20æ¬¡ | 10æ¬¡ | 1å°æ—¶ |
| é‡ç½®å¯†ç  | 5æ¬¡ | 3æ¬¡ | 24å°æ—¶ |

## ğŸ”„ éœ€è¦é‡å¯åç«¯

å› ä¸ºä¿®æ”¹äº†ä¸­é—´ä»¶å’Œè·¯ç”±ï¼Œéœ€è¦é‡å¯åç«¯ï¼š

```bash
# åœæ­¢åç«¯
Ctrl+C

# é‡å¯åç«¯
cd server
npm run dev

# æˆ–ä½¿ç”¨PM2
pm2 restart server
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•1ï¼šæ­£å¸¸æ³¨å†Œ
```bash
# ç¬¬1æ¬¡æ³¨å†Œ
curl -X POST http://localhost:3001/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "test1",
    "email": "test1@example.com",
    "password": "password123"
  }'

# åº”è¯¥æˆåŠŸ
```

### æµ‹è¯•2ï¼šåŒIPå¤šæ¬¡æ³¨å†Œ
```bash
# è¿ç»­æ³¨å†Œ6æ¬¡ï¼ˆä½¿ç”¨ä¸åŒé‚®ç®±ï¼‰
for i in {1..6}; do
  curl -X POST http://localhost:3001/api/auth/register \
    -H "Content-Type: application/json" \
    -d "{
      \"username\": \"test$i\",
      \"email\": \"test$i@example.com\",
      \"password\": \"password123\"
    }"
  echo ""
done

# å‰5æ¬¡åº”è¯¥æˆåŠŸï¼Œç¬¬6æ¬¡åº”è¯¥å¤±è´¥
```

### æµ‹è¯•3ï¼šæŸ¥çœ‹å“åº”å¤´
```bash
curl -i -X POST http://localhost:3001/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "test",
    "email": "test@example.com",
    "password": "password123"
  }'

# æŸ¥çœ‹å“åº”å¤´ï¼š
# X-RateLimit-Limit-IP: 5
# X-RateLimit-Remaining-IP: 4
```

## ğŸ’¡ ç®¡ç†å‘˜æŸ¥çœ‹é™åˆ¶è®°å½•

å¯ä»¥åœ¨æ•°æ®åº“ä¸­æŸ¥çœ‹é™åˆ¶è®°å½•ï¼š

```javascript
// æŸ¥çœ‹æ‰€æœ‰æ³¨å†Œé™åˆ¶è®°å½•
db.ratelimits.find({ action: "register" })

// æŸ¥çœ‹ç‰¹å®šIPçš„è®°å½•
db.ratelimits.find({ 
  identifier: "192.168.1.100",
  action: "register"
})

// æ¸…é™¤ç‰¹å®šIPçš„é™åˆ¶ï¼ˆç´§æ€¥æƒ…å†µï¼‰
db.ratelimits.deleteMany({ 
  identifier: "192.168.1.100",
  action: "register"
})
```

## ğŸ”§ è‡ªå®šä¹‰é…ç½®

å¦‚æœéœ€è¦è°ƒæ•´é™åˆ¶ï¼Œä¿®æ”¹ `server/middleware/rateLimit.js`ï¼š

```javascript
const RATE_LIMITS = {
  register: {
    email: { max: 5, window: 24 * 60 * 60 * 1000 },  // æ”¹ä¸ºæ¯å¤©5æ¬¡
    ip: { max: 10, window: 60 * 60 * 1000 }          // æ”¹ä¸ºæ¯å°æ—¶10æ¬¡
  }
};
```

## ğŸ›¡ï¸ å®‰å…¨å»ºè®®

### 1. é…åˆå…¶ä»–å®‰å…¨æªæ–½
- âœ… é‚®ç®±éªŒè¯
- âœ… éªŒè¯ç ï¼ˆå¯é€‰ï¼‰
- âœ… IPé™åˆ¶ï¼ˆå·²å®ç°ï¼‰
- âœ… å¯†ç å¼ºåº¦è¦æ±‚

### 2. ç›‘æ§å¼‚å¸¸æ³¨å†Œ
- å®šæœŸæ£€æŸ¥æ³¨å†Œæ—¥å¿—
- å…³æ³¨åŒä¸€IPçš„å¤šæ¬¡æ³¨å†Œ
- ç›‘æ§æ³¨å†ŒæˆåŠŸç‡

### 3. è°ƒæ•´é™åˆ¶ç­–ç•¥
æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼š
- æ­£å¸¸ç½‘ç«™ï¼š5æ¬¡/å°æ—¶
- é«˜æµé‡ç½‘ç«™ï¼š10æ¬¡/å°æ—¶
- ä¸¥æ ¼é™åˆ¶ï¼š3æ¬¡/å°æ—¶

## âœ… æ€»ç»“

**ç°åœ¨ç³»ç»Ÿå¯ä»¥é˜²æ­¢åŒä¸€IPé¢‘ç¹æ³¨å†Œè´¦æˆ·**ï¼š

- âœ… åŒä¸€IPæ¯å°æ—¶æœ€å¤šæ³¨å†Œ5æ¬¡
- âœ… åŒä¸€é‚®ç®±æ¯å¤©æœ€å¤šå°è¯•3æ¬¡
- âœ… è¶…è¿‡é™åˆ¶ä¼šè¿”å›å‹å¥½çš„é”™è¯¯æç¤º
- âœ… è‡ªåŠ¨è®°å½•å’Œæ¸…ç†é™åˆ¶æ•°æ®
- âœ… æ”¯æŒNginxä»£ç†ç¯å¢ƒ

**é‡å¯åç«¯åå³å¯ç”Ÿæ•ˆï¼** ğŸ›¡ï¸
