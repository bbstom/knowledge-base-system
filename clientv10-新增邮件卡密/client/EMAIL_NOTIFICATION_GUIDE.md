# 邮箱验证和通知系统使用指南

## 📧 概述

系统现在支持完整的邮箱验证和通知功能，包括：
- 新用户注册邮箱验证
- 密码找回功能
- 管理员推送优惠通知
- 用户登录后弹窗显示通知

---

## 🔐 邮箱验证系统

### 1. 新用户注册流程

**用户操作：**
1. 访问注册页面 `/register`
2. 填写用户名、邮箱
3. 输入密码（至少6位）
4. 再次输入密码确认
5. 可选填写推荐码
6. 提交注册

**密码确认：**
- 两次输入的密码必须一致
- 实时显示密码匹配状态
- 不一致时显示错误提示

**系统处理：**
1. 创建用户账户（邮箱未验证状态）
2. 发送验证邮件到用户邮箱
3. 邮件包含验证链接（24小时有效）
4. 显示成功提示

**验证邮件模板：**
```html
主题：验证您的 InfoSearch 账户

尊敬的 {{username}}，

感谢您注册 InfoSearch 平台！

请点击下面的链接验证您的邮箱地址：
{{verify_link}}

此链接24小时内有效。

如果您没有注册此账户，请忽略此邮件。

---
InfoSearch Team
```

### 2. 邮箱验证页面

**访问路径：** `/verify-email?token=xxx`

**页面状态：**
- 🔄 **验证中**：显示加载动画
- ✅ **验证成功**：显示成功图标，3秒后跳转登录
- ❌ **验证失败**：显示错误信息，提供重新发送选项

**验证成功后：**
- 用户邮箱状态更新为已验证
- 自动跳转到登录页面
- 可以正常登录使用

### 3. 重新发送验证邮件

**访问路径：** `/resend-verification`

**使用场景：**
- 验证邮件未收到
- 验证链接已过期
- 邮件被误删

**操作步骤：**
1. 输入注册时使用的邮箱
2. 点击"发送验证邮件"
3. 查收新的验证邮件
4. 点击验证链接

---

## 🔐 登录验证码系统

### 1. 验证码功能

**验证码类型：** 4位数字图形验证码

**功能特点：**
- 自动生成4位随机数字
- 图形化显示，防止机器人
- 添加干扰线和干扰点
- 数字随机旋转和颜色
- 点击图片或刷新按钮重新生成
- 实时验证输入正确性

**用户操作：**
1. 在登录页面输入邮箱和密码
2. 查看验证码图片
3. 输入4位数字验证码
4. 验证码正确显示绿色对勾
5. 验证码错误显示红色叉号
6. 点击图片或刷新按钮可重新生成

**验证规则：**
- 只能输入数字
- 最多4位
- 必须与图片中的验证码完全一致
- 验证码错误无法提交登录

### 2. 防机器人机制

**安全特性：**
- 图形验证码防止自动化登录
- 每次刷新生成新的验证码
- 验证码包含干扰元素
- 数字随机旋转角度
- 随机颜色和位置

**用户体验：**
- 验证码清晰易读
- 一键刷新功能
- 实时验证反馈
- 错误提示明确

---

## 🔑 密码找回系统

### 1. 忘记密码流程

**访问路径：** `/forgot-password`

**用户操作：**
1. 点击登录页面的"忘记密码？"链接
2. 输入注册时使用的邮箱
3. 点击"发送重置邮件"
4. 查收密码重置邮件

**重置邮件模板：**
```html
主题：重置您的 InfoSearch 密码

尊敬的 {{username}}，

我们收到了您的密码重置请求。

请点击下面的链接重置您的密码：
{{reset_link}}

此链接24小时内有效。

如果您没有请求重置密码，请忽略此邮件，您的密码将保持不变。

---
InfoSearch Team
```

### 2. 重置密码页面

**访问路径：** `/reset-password?token=xxx`

**操作步骤：**
1. 点击邮件中的重置链接
2. 输入新密码（至少6位）
3. 确认新密码
4. 点击"重置密码"
5. 重置成功后跳转登录

**密码要求：**
- 至少6个字符
- 建议包含字母和数字
- 避免使用过于简单的密码

---

## 📢 通知管理系统

### 1. 管理员创建通知

**访问路径：** `/admin/notifications`

**通知类型：**

#### 纯文本通知
```
标题：🎉 新用户专享优惠
内容：注册即送100积分，首次充值享8折优惠！
```

#### 图片+文字通知
```
标题：VIP会员限时优惠
图片：https://example.com/vip-banner.jpg
内容：升级VIP享受更多特权...
```

#### HTML格式通知
```html
<div class="text-center">
  <h2 class="text-2xl font-bold text-blue-600 mb-4">
    VIP会员限时优惠
  </h2>
  <p class="text-lg mb-4">升级VIP享受更多特权：</p>
  <ul class="text-left space-y-2">
    <li>✓ 搜索次数无限制</li>
    <li>✓ 专属客服支持</li>
    <li>✓ 优先数据更新</li>
    <li>✓ 更多积分奖励</li>
  </ul>
  <p class="mt-6 text-red-600 font-bold">
    限时优惠：原价 ¥299，现价 ¥199
  </p>
</div>
```

### 2. 通知配置选项

**基本信息：**
- 标题：通知标题（必填）
- 内容：通知内容（必填）
- 类型：text/image/html

**目标用户：**
- 所有用户
- VIP用户
- 新用户（注册7天内）
- 活跃用户

**优先级：**
- 低：普通通知
- 中：重要通知
- 高：紧急通知（优先显示）

**有效期：**
- 开始日期：通知生效日期
- 结束日期：通知失效日期（留空表示永久）

**状态：**
- 草稿：未发布
- 生效中：正在显示
- 已过期：已失效

### 3. 通知显示规则

**显示时机：**
- 用户登录后自动弹窗
- 每个通知每天只显示一次
- 按优先级排序显示

**显示条件：**
- 通知状态为"生效中"
- 当前日期在有效期内
- 用户符合目标用户条件
- 用户今天未查看过该通知

**优先级排序：**
1. 高优先级通知
2. 中优先级通知
3. 低优先级通知

### 4. 通知统计

**统计指标：**
- 总通知数
- 生效中的通知数
- 草稿数量
- 总浏览量

**单个通知统计：**
- 浏览次数
- 创建时间
- 最后更新时间

---

## 🎨 通知样式示例

### 文本通知
```
┌─────────────────────────────────┐
│  🎉 新用户专享优惠               │
├─────────────────────────────────┤
│                                 │
│  注册即送100积分，首次充值享    │
│  8折优惠！活动时间有限，快来    │
│  参与吧！                       │
│                                 │
│           [我知道了]             │
└─────────────────────────────────┘
```

### 图片通知
```
┌─────────────────────────────────┐
│  VIP会员限时优惠                 │
├─────────────────────────────────┤
│                                 │
│  ┌─────────────────────────┐   │
│  │                         │   │
│  │    [VIP Banner Image]   │   │
│  │                         │   │
│  └─────────────────────────┘   │
│                                 │
│  升级VIP享受更多特权...         │
│                                 │
│           [我知道了]             │
└─────────────────────────────────┘
```

### HTML通知
```
┌─────────────────────────────────┐
│  VIP会员限时优惠                 │
├─────────────────────────────────┤
│                                 │
│    VIP会员限时优惠               │
│                                 │
│  升级VIP享受更多特权：           │
│  ✓ 搜索次数无限制               │
│  ✓ 专属客服支持                 │
│  ✓ 优先数据更新                 │
│  ✓ 更多积分奖励                 │
│                                 │
│  限时优惠：原价 ¥299，现价 ¥199 │
│                                 │
│           [我知道了]             │
└─────────────────────────────────┘
```

---

## ⚙️ SMTP配置

### 1. 配置SMTP服务器

**访问路径：** `/admin/settings` → 邮件配置

**必填信息：**
- SMTP主机：smtp.example.com
- SMTP端口：587（TLS）或 465（SSL）
- SMTP用户名：your-email@example.com
- SMTP密码：your-password
- 发件人名称：InfoSearch
- 发件人邮箱：noreply@infosearch.com

### 2. 常用SMTP服务商

#### Gmail
```
主机：smtp.gmail.com
端口：587
加密：TLS
注意：需要开启"允许不够安全的应用"或使用应用专用密码
```

#### 阿里云邮件推送
```
主机：smtpdm.aliyun.com
端口：465
加密：SSL
注意：需要在阿里云控制台配置发信域名
```

#### 腾讯企业邮箱
```
主机：smtp.exmail.qq.com
端口：465
加密：SSL
```

#### SendGrid
```
主机：smtp.sendgrid.net
端口：587
加密：TLS
用户名：apikey
密码：你的API密钥
```

### 3. 测试邮件发送

**测试步骤：**
1. 配置SMTP信息
2. 点击"发送测试邮件"
3. 输入测试邮箱地址
4. 查收测试邮件
5. 确认配置正确

---

## 📝 邮件模板管理

### 1. 默认邮件模板

**欢迎邮件（welcome）：**
- 用途：新用户注册后发送
- 变量：{{username}}, {{email}}

**邮箱验证（verify_email）：**
- 用途：发送验证链接
- 变量：{{username}}, {{verify_link}}

**密码重置（reset_password）：**
- 用途：发送重置链接
- 变量：{{username}}, {{reset_link}}

**搜索通知（search_notification）：**
- 用途：搜索结果通知
- 变量：{{username}}, {{date}}

**提现通知（withdraw_notification）：**
- 用途：提现状态通知
- 变量：{{username}}, {{amount}}, {{date}}

### 2. 自定义邮件模板

**访问路径：** `/admin/settings` → 邮件配置 → 邮件模板

**模板变量：**
- `{{username}}` - 用户名
- `{{email}}` - 邮箱地址
- `{{verify_link}}` - 验证链接
- `{{reset_link}}` - 重置链接
- `{{amount}}` - 金额
- `{{date}}` - 日期

**HTML模板示例：**
```html
<!DOCTYPE html>
<html>
<head>
  <style>
    body { font-family: Arial, sans-serif; }
    .header { 
      background: #4F46E5; 
      color: white; 
      padding: 20px; 
      text-align: center;
    }
    .content { padding: 20px; }
    .button { 
      background: #4F46E5; 
      color: white; 
      padding: 12px 24px; 
      text-decoration: none;
      border-radius: 6px;
      display: inline-block;
    }
    .footer {
      background: #f3f4f6;
      padding: 20px;
      text-align: center;
      font-size: 12px;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>InfoSearch</h1>
  </div>
  <div class="content">
    <p>尊敬的 {{username}}，</p>
    <p>感谢您注册 InfoSearch 平台！</p>
    <p>请点击下面的按钮验证您的邮箱：</p>
    <p style="text-align: center; margin: 30px 0;">
      <a href="{{verify_link}}" class="button">验证邮箱</a>
    </p>
    <p>或复制以下链接到浏览器：</p>
    <p style="word-break: break-all; color: #6b7280;">
      {{verify_link}}
    </p>
    <p>此链接24小时内有效。</p>
  </div>
  <div class="footer">
    <p>© 2024 InfoSearch. All rights reserved.</p>
    <p>如果您没有注册此账户，请忽略此邮件。</p>
  </div>
</body>
</html>
```

---

## 🔔 用户通知体验

### 1. 登录后通知流程

**用户登录：**
1. 输入邮箱和密码
2. 点击登录
3. 验证成功

**系统检查：**
1. 查询当前生效的通知
2. 过滤用户已查看的通知
3. 按优先级排序
4. 选择最高优先级通知

**显示通知：**
1. 弹出通知模态框
2. 显示通知内容
3. 记录浏览次数
4. 用户点击"我知道了"关闭

### 2. 通知显示规则

**每日一次：**
- 每个通知每天只显示一次
- 使用Cookie或LocalStorage记录
- 第二天重置显示状态

**优先级显示：**
- 高优先级优先显示
- 同优先级按创建时间排序
- 一次只显示一个通知

**目标用户过滤：**
- 新用户：注册7天内
- VIP用户：已购买VIP
- 活跃用户：最近30天有活动
- 所有用户：不限制

---

## 📊 数据统计

### 1. 邮件发送统计

**统计指标：**
- 总发送数
- 成功发送数
- 失败发送数
- 打开率
- 点击率

### 2. 通知浏览统计

**统计指标：**
- 总浏览量
- 单个通知浏览量
- 用户查看率
- 平均查看时长

---

## 🚨 常见问题

### Q: 收不到验证邮件怎么办？
A: 
1. 检查垃圾邮件文件夹
2. 确认邮箱地址正确
3. 等待几分钟后重试
4. 使用"重新发送验证邮件"功能

### Q: 验证链接过期了怎么办？
A: 访问 `/resend-verification` 重新发送验证邮件

### Q: 如何修改SMTP配置？
A: 访问 `/admin/settings` → 邮件配置 → 修改SMTP信息

### Q: 通知不显示怎么办？
A: 
1. 检查通知状态是否为"生效中"
2. 确认当前日期在有效期内
3. 检查目标用户设置
4. 清除浏览器缓存

### Q: 如何停止显示某个通知？
A: 将通知状态改为"草稿"或"已过期"

---

## 🔐 安全建议

### 邮件安全
1. 使用SSL/TLS加密
2. 不在邮件中包含敏感信息
3. 验证链接设置过期时间
4. 记录邮件发送日志

### 通知安全
1. 过滤HTML内容，防止XSS
2. 限制通知显示频率
3. 记录通知查看日志
4. 定期清理过期通知

---

**版本：** 1.0.0  
**最后更新：** 2024-10-19
